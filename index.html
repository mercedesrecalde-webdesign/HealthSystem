<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="Sistema de gesti√≥n de cuidados de enfermer√≠a para Patricio Recalde">
  <meta name="theme-color" content="#14b8a6">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Recalde Health">
  <meta name="application-name" content="Recalde Health">
  <meta name="msapplication-TileColor" content="#14b8a6">
  <meta name="format-detection" content="telephone=no">
  <title>Recalde Health System</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">

  <!-- Fallback favicon SVG -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2314b8a6' rx='20' width='100' height='100'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>‚ô•</text></svg>">

  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase para sincronizaci√≥n de reportes -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    input,
    button,
    select,
    textarea {
      font-family: inherit;
      font-size: 16px;
    }

    .hidden {
      display: none !important;
    }

    .check-btn {
      transition: all 0.3s ease;
    }

    .check-btn:active {
      transform: scale(0.95);
    }

    .section-btn:active {
      transform: scale(0.98);
    }

    /* Safe area para notch en Android/iOS */
    .safe-top {
      padding-top: env(safe-area-inset-top);
    }

    .safe-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Banner de instalaci√≥n */
    .install-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #14b8a6 0%, #0891b2 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 9999;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .install-banner.show {
      transform: translateY(0);
    }

    .install-banner button {
      background: white;
      color: #0891b2;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .install-banner .close-btn {
      background: transparent;
      color: white;
      padding: 8px;
      font-size: 20px;
    }

    /* Notificaci√≥n de alarma */
    .alarm-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-150%);
      background: white;
      border-radius: 20px;
      padding: 20px 24px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      max-width: 90%;
      width: 400px;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .alarm-notification.show {
      transform: translateX(-50%) translateY(0);
    }

    .alarm-notification.medicacion {
      border-left: 6px solid #f43f5e;
      background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
    }

    .alarm-notification.tarea {
      border-left: 6px solid #3b82f6;
    }

    .alarm-notification.higiene {
      border-left: 6px solid #06b6d4;
      background: linear-gradient(135deg, #fff 0%, #f0fdfa 100%);
    }

    .alarm-notification.rotacion {
      border-left: 6px solid #8b5cf6;
      background: linear-gradient(135deg, #fff 0%, #f5f3ff 100%);
    }

    .alarm-notification.alimentacion {
      border-left: 6px solid #f59e0b;
      background: linear-gradient(135deg, #fff 0%, #fffbeb 100%);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: translateX(-50%) scale(1);
      }

      50% {
        opacity: 0.9;
        transform: translateX(-50%) scale(1.02);
      }
    }

    .alarm-notification h3 {
      margin: 0 0 8px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alarm-notification p {
      margin: 0 0 16px;
      color: #64748b;
      font-size: 14px;
    }

    .alarm-notification .buttons {
      display: flex;
      gap: 10px;
    }

    .alarm-notification button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .alarm-notification .btn-snooze {
      background: #f1f5f9;
      color: #475569;
    }

    .alarm-notification .btn-done {
      background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
      color: white;
    }

    /* Indicador de guardado */
    .save-indicator {
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      z-index: 9998;
    }

    .save-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Toggle de alarmas */
    .alarm-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .alarm-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .alarm-toggle input {
      display: none;
    }

    .alarm-toggle .toggle-switch {
      width: 36px;
      height: 20px;
      background: #475569;
      border-radius: 10px;
      position: relative;
      transition: all 0.3s;
    }

    .alarm-toggle input:checked+.toggle-switch {
      background: #10b981;
    }

    .alarm-toggle .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: all 0.3s;
    }

    .alarm-toggle input:checked+.toggle-switch::after {
      left: 18px;
    }
  </style>
</head>

<body>
  <!-- Notificaci√≥n de alarma -->
  <div id="alarm-notification" class="alarm-notification">
    <h3 id="alarm-title">‚è∞ T√≠tulo de alarma</h3>
    <p id="alarm-description">Descripci√≥n de la alarma</p>
    <div class="buttons">
      <button class="btn-snooze" onclick="snoozeAlarm()">‚è∞ Posponer 5 min</button>
      <button class="btn-done" onclick="dismissAlarm()">‚úì Listo</button>
    </div>
  </div>

  <!-- Indicador de guardado -->
  <div id="save-indicator" class="save-indicator">üíæ Guardado</div>

  <!-- Banner de instalaci√≥n PWA -->
  <div id="install-banner" class="install-banner">
    <div style="flex: 1;">
      <strong>üì± Instalar App</strong>
      <p style="margin: 4px 0 0; font-size: 13px; opacity: 0.9;">Agreg√° Recalde Health a tu pantalla de inicio</p>
    </div>
    <button onclick="installPWA()">Instalar</button>
    <button class="close-btn" onclick="closeInstallBanner()">‚úï</button>
  </div>

  <!-- ==================== PANTALLA DE INICIO ==================== -->
  <div id="pantalla-inicio"
    class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4 flex items-center justify-center">
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <div
          class="inline-flex items-center justify-center w-28 h-28 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-3xl shadow-2xl mb-6 relative">
          <svg class="w-14 h-14 text-white" fill="white" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
          </svg>
          <div
            class="absolute -bottom-1 -right-1 w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
            <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path
                d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3" />
              <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4" />
              <circle cx="20" cy="10" r="2" />
            </svg>
          </div>
        </div>
        <h1 class="text-4xl font-black text-white tracking-tight mb-1">Recalde Health</h1>
        <p class="text-xl font-bold text-teal-400">System</p>
        <p class="text-slate-400 mt-2 font-medium">Plan de Cuidados - Patricio Recalde</p>
      </div>

      <!-- Formulario -->
      <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-6 border border-white/20 mb-6">
        <div class="space-y-4 mb-6">
          <div>
            <label class="flex items-center gap-2 text-sm font-semibold text-slate-300 mb-2">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
              </svg>
              Enfermero/a a Cargo
            </label>
            <input type="text" id="input-enfermero"
              class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-slate-400 focus:border-teal-400 focus:outline-none transition-all text-lg font-medium"
              placeholder="Nombre completo">
          </div>
          <div>
            <label class="flex items-center gap-2 text-sm font-semibold text-slate-300 mb-2">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" />
              </svg>
              Auxiliar de Enfermer√≠a
            </label>
            <input type="text" id="input-auxiliar"
              class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-slate-400 focus:border-teal-400 focus:outline-none transition-all text-lg font-medium"
              placeholder="Nombre completo">
          </div>
        </div>

        <!-- Botones de guardia -->
        <div class="grid grid-cols-2 gap-3 mb-4">
          <button onclick="iniciarGuardia('diurna')" id="btn-diurna"
            class="p-4 rounded-2xl transition-all duration-300 bg-slate-700 text-slate-500 cursor-not-allowed" disabled>
            <svg class="w-8 h-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="4" />
              <path
                d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" />
            </svg>
            <p class="font-bold text-lg">Diurna</p>
            <p class="text-sm opacity-80">08:00 - 20:00</p>
          </button>
          <button onclick="iniciarGuardia('nocturna')" id="btn-nocturna"
            class="p-4 rounded-2xl transition-all duration-300 bg-slate-700 text-slate-500 cursor-not-allowed" disabled>
            <svg class="w-8 h-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
            <p class="font-bold text-lg">Nocturna</p>
            <p class="text-sm opacity-80">20:00 - 08:00</p>
          </button>
        </div>
      </div>

      <!-- Bot√≥n Admin -->
      <button onclick="mostrarLoginAdmin()" id="btn-admin-inicio"
        class="w-full py-3 bg-white/5 border border-white/10 rounded-2xl text-slate-400 font-semibold flex items-center justify-center gap-2 hover:bg-white/10 transition-all relative">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3" />
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </svg>
        Panel de Administraci√≥n
        <span id="badge-reportes-nuevos"
          class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">0</span>
      </button>

      <!-- Hora actual -->
      <div class="text-center mt-6">
        <p id="fecha-actual" class="text-slate-500 font-medium"></p>
        <p id="hora-actual" class="text-3xl font-bold text-white font-mono"></p>
      </div>
    </div>
  </div>

  <!-- ==================== LOGIN ADMIN ==================== -->
  <div id="pantalla-login-admin"
    class="hidden min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4 flex items-center justify-center">
    <div class="w-full max-w-sm">
      <button onclick="volverInicio()"
        class="mb-6 text-slate-400 flex items-center gap-2 hover:text-white transition-all">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          <path d="M9 22V12h6v10" />
        </svg>
        Volver al inicio
      </button>
      <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-6 border border-white/20">
        <div class="text-center mb-6">
          <div
            class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl mb-4">
            <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3" />
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-white">Administrador</h2>
        </div>
        <input type="password" id="input-admin-password"
          class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-slate-400 focus:border-violet-400 focus:outline-none mb-4"
          placeholder="Contrase√±a">
        <button onclick="loginAdmin()"
          class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl font-bold hover:shadow-lg transition-all">
          Ingresar
        </button>
        <p class="text-xs text-slate-500 text-center mt-3">Contrase√±a: recalde2024</p>
      </div>
    </div>
  </div>

  <!-- ==================== PANEL ADMIN ==================== -->
  <div id="pantalla-admin" class="hidden min-h-screen bg-gradient-to-br from-slate-100 to-slate-200">
    <!-- Header Admin -->
    <div class="bg-gradient-to-r from-violet-600 to-purple-600 text-white p-4 sticky top-0 z-50">
      <div class="max-w-4xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>
          <div>
            <h1 class="text-xl font-bold">Panel de Administraci√≥n</h1>
            <p class="text-sm text-white/70">Recalde Health System</p>
          </div>
        </div>
        <button onclick="volverInicio()"
          class="px-4 py-2 bg-white/20 rounded-xl font-semibold hover:bg-white/30 transition-all">
          Salir
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white border-b sticky top-16 z-40">
      <div class="max-w-4xl mx-auto flex">
        <button onclick="cambiarTabAdmin('medicacion')" id="tab-medicacion"
          class="flex-1 py-4 flex items-center justify-center gap-2 font-semibold text-violet-600 border-b-2 border-violet-600 bg-violet-50">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path
              d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
          </svg>
          Medicaci√≥n
        </button>
        <button onclick="cambiarTabAdmin('tareas')" id="tab-tareas"
          class="flex-1 py-4 flex items-center justify-center gap-2 font-semibold text-slate-500 hover:text-slate-700">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
          </svg>
          Tareas
        </button>
        <button onclick="cambiarTabAdmin('rotacion')" id="tab-rotacion"
          class="flex-1 py-4 flex items-center justify-center gap-2 font-semibold text-slate-500 hover:text-slate-700">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
            <path d="M3 3v5h5" />
          </svg>
          Rotaci√≥n
        </button>
        <button onclick="cambiarTabAdmin('reportes')" id="tab-reportes"
          class="flex-1 py-4 flex items-center justify-center gap-2 font-semibold text-slate-500 hover:text-slate-700">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
          </svg>
          Reportes
        </button>
      </div>
    </div>

    <!-- Contenido Admin -->
    <div class="max-w-4xl mx-auto p-4">
      <!-- Tab Medicaci√≥n -->
      <div id="content-medicacion">
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
          <h3 class="font-bold text-lg text-slate-800 mb-4">‚ûï Agregar Medicaci√≥n</h3>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <input type="time" id="nuevo-med-hora"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
            <select id="nuevo-med-guardia"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
              <option value="diurna">Guardia Diurna</option>
              <option value="nocturna">Guardia Nocturna</option>
            </select>
          </div>
          <div class="grid grid-cols-4 gap-2 mb-3">
            <input type="text" id="nuevo-med-nombre" placeholder="Medicamento"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
            <input type="text" id="nuevo-med-dosis" placeholder="Dosis"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
            <input type="text" id="nuevo-med-cantidad" placeholder="Cantidad"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
            <input type="text" id="nuevo-med-obs" placeholder="Observaciones"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
          </div>
          <button onclick="agregarMedicacion()"
            class="px-4 py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
            üíæ Guardar
          </button>
        </div>
        <h3 class="font-bold text-lg text-slate-700 mb-3">Medicaci√≥n Programada</h3>
        <div id="lista-medicacion" class="space-y-3"></div>
      </div>

      <!-- Tab Tareas -->
      <div id="content-tareas" class="hidden">
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
          <h3 class="font-bold text-lg text-slate-800 mb-4">‚ûï Agregar Tarea</h3>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <input type="text" id="nueva-tarea-nombre" placeholder="Nombre de la tarea"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
            <input type="text" id="nueva-tarea-horario" placeholder="Horario"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
          </div>
          <textarea id="nueva-tarea-detalle" placeholder="Detalle / Instrucciones"
            class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none mb-3"
            rows="2"></textarea>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <select id="nueva-tarea-guardia"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
              <option value="diurna">Guardia Diurna</option>
              <option value="nocturna">Guardia Nocturna</option>
              <option value="ambas">Ambas Guardias</option>
            </select>
            <select id="nueva-tarea-tipo"
              class="px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
              <option value="csv">Control Signos Vitales</option>
              <option value="higiene">Higiene</option>
              <option value="alimentacion">Alimentaci√≥n</option>
              <option value="hidratacion">Hidrataci√≥n</option>
              <option value="rotacion">Rotaci√≥n</option>
              <option value="movilidad">Movilidad</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <button onclick="agregarTarea()"
            class="px-4 py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
            üíæ Guardar Tarea
          </button>
        </div>
        <h3 class="font-bold text-lg text-slate-700 mb-3">Tareas Programadas</h3>
        <div id="lista-tareas" class="space-y-3"></div>
      </div>

      <!-- Tab Rotaci√≥n -->
      <div id="content-rotacion" class="hidden">
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
          <h3 class="font-bold text-lg text-slate-800 mb-4">Puntos de Control en Rotaci√≥n</h3>
          <div id="lista-controles" class="space-y-2 mb-4"></div>
          <div class="flex gap-2">
            <input type="text" id="nuevo-control" placeholder="Nuevo punto de control"
              class="flex-1 px-3 py-2 rounded-xl border border-slate-200 focus:border-violet-400 focus:outline-none">
            <button onclick="agregarControl()"
              class="px-4 py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl font-semibold">
              ‚ûï
            </button>
          </div>
        </div>
        <div class="bg-gradient-to-br from-violet-50 to-purple-50 rounded-2xl p-6 border border-violet-100">
          <h3 class="font-bold text-lg text-violet-800 mb-3">Secuencia de Rotaci√≥n</h3>
          <div class="flex items-center gap-2 flex-wrap text-sm">
            <span class="px-3 py-1 bg-white rounded-lg font-semibold text-slate-700 shadow-sm">Dec√∫bito Dorsal</span>
            <span class="text-violet-400">‚Üí</span>
            <span class="px-3 py-1 bg-white rounded-lg font-semibold text-slate-700 shadow-sm">Lateral Der 30¬∞</span>
            <span class="text-violet-400">‚Üí</span>
            <span class="px-3 py-1 bg-white rounded-lg font-semibold text-slate-700 shadow-sm">Dec√∫bito Dorsal</span>
            <span class="text-violet-400">‚Üí</span>
            <span class="px-3 py-1 bg-white rounded-lg font-semibold text-slate-700 shadow-sm">Lateral Izq 30¬∞</span>
            <span class="text-violet-400">‚Üí</span>
            <span class="text-violet-400 font-bold">Repetir</span>
          </div>
          <div class="mt-4 p-3 bg-amber-50 rounded-xl border border-amber-200">
            <p class="text-sm text-amber-800">
              ‚ö†Ô∏è <strong>Nota:</strong> Durante la noche, espaciar rotaciones si el paciente est√° durmiendo.
            </p>
          </div>
        </div>
      </div>

      <!-- Tab Reportes -->
      <div id="content-reportes" class="hidden">
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg text-slate-800">üìä Reportes de Guardia</h3>
            <button onclick="exportarReportesCSV()"
              class="px-4 py-2 bg-emerald-500 text-white rounded-xl font-semibold text-sm hover:bg-emerald-600 transition-all">
              üì• Exportar CSV
            </button>
          </div>
          <p class="text-sm text-slate-500 mb-4">Historial de todos los informes enviados por los enfermeros</p>
          <div id="lista-reportes" class="space-y-4"></div>
          <div id="sin-reportes" class="hidden text-center py-12">
            <div class="text-6xl mb-4">üìã</div>
            <p class="text-slate-500 font-medium">No hay reportes todav√≠a</p>
            <p class="text-slate-400 text-sm">Los reportes aparecer√°n aqu√≠ cuando los enfermeros env√≠en sus informes de
              guardia</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== VISTA DE GUARDIA ==================== -->
  <div id="pantalla-guardia" class="hidden min-h-screen">
    <!-- Header Guardia -->
    <div id="header-guardia" class="sticky top-0 z-50 p-4">
      <div class="max-w-2xl mx-auto">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div id="logo-guardia" class="p-2 rounded-xl shadow-lg">
              <svg class="w-6 h-6 text-white" fill="white" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path
                  d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
              </svg>
            </div>
            <div>
              <h1 id="titulo-guardia" class="text-lg font-black">Recalde Health</h1>
              <p id="subtitulo-guardia" class="text-xs font-semibold">Patricio Recalde</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <label class="alarm-toggle" id="alarm-toggle-container">
              <input type="checkbox" id="alarm-toggle" checked onchange="toggleAlarmas()">
              <span class="toggle-switch"></span>
              <span id="alarm-toggle-label" class="text-xs font-semibold">üîî</span>
            </label>
            <button onclick="confirmarSalir()" id="btn-home-guardia"
              class="px-3 py-2 rounded-xl flex items-center gap-1.5 font-semibold text-sm">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />
              </svg>
              Salir
            </button>
            <div id="badge-hora-guardia" class="px-3 py-1.5 rounded-xl flex items-center gap-2">
              <span id="icono-guardia"></span>
              <span id="hora-guardia" class="text-sm font-bold"></span>
            </div>
          </div>
        </div>

        <div id="info-personal-guardia" class="flex items-center gap-4 mt-3 text-xs"></div>

        <div class="mt-3">
          <div class="flex justify-between items-center mb-1">
            <span id="label-progreso" class="text-xs font-semibold">Progreso de guardia</span>
            <span id="valor-progreso" class="text-sm font-black">0%</span>
          </div>
          <div id="barra-progreso-bg" class="h-2 rounded-full overflow-hidden">
            <div id="barra-progreso" class="h-full rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido Guardia -->
    <div class="max-w-2xl mx-auto p-4 pb-28 space-y-4">
      <!-- Signos Vitales -->
      <div id="card-signos-vitales" class="rounded-3xl p-4 border">
        <div class="flex items-center gap-3 mb-4">
          <div id="icono-sv" class="p-2 rounded-xl">
            <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path
                d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3" />
              <path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4" />
              <circle cx="20" cy="10" r="2" />
            </svg>
          </div>
          <div>
            <h2 id="titulo-sv" class="text-lg font-bold">Control de Signos Vitales</h2>
            <p id="subtitulo-sv" class="text-xs">Registrar al inicio de la guardia</p>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
          <div>
            <label id="label-pa" class="text-xs font-semibold block text-center mb-1">PA</label>
            <input type="text" id="sv-pa" placeholder="120/80"
              class="w-full px-2 py-2 text-center text-sm rounded-xl border outline-none">
          </div>
          <div>
            <label id="label-fc" class="text-xs font-semibold block text-center mb-1">FC</label>
            <input type="text" id="sv-fc" placeholder="70"
              class="w-full px-2 py-2 text-center text-sm rounded-xl border outline-none">
          </div>
          <div>
            <label id="label-temp" class="text-xs font-semibold block text-center mb-1">T¬∞</label>
            <input type="text" id="sv-temp" placeholder="36.5"
              class="w-full px-2 py-2 text-center text-sm rounded-xl border outline-none">
          </div>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div>
            <label id="label-spo2" class="text-xs font-semibold block text-center mb-1">SpO2</label>
            <input type="text" id="sv-spo2" placeholder="98"
              class="w-full px-2 py-2 text-center text-sm rounded-xl border outline-none">
          </div>
          <div>
            <label id="label-fr" class="text-xs font-semibold block text-center mb-1">FR</label>
            <input type="text" id="sv-fr" placeholder="16"
              class="w-full px-2 py-2 text-center text-sm rounded-xl border outline-none">
          </div>
          <div>
            <label id="label-gluc" class="text-xs font-semibold block text-center mb-1">Gluc ü©∏</label>
            <input type="text" id="sv-gluc" placeholder="mg/dL"
              class="w-full px-2 py-2 text-center text-sm rounded-xl border outline-none">
          </div>
        </div>
      </div>

      <!-- Secci√≥n Medicaci√≥n -->
      <div>
        <button onclick="toggleSeccion('medicacion-guardia')" id="btn-seccion-medicacion"
          class="section-btn w-full flex items-center justify-between p-4 rounded-2xl mb-3 bg-gradient-to-r from-rose-400 to-pink-500">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-white/30 rounded-xl backdrop-blur-sm">
              <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path
                  d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
              </svg>
            </div>
            <h2 class="text-xl font-bold text-white tracking-tight">Medicaci√≥n</h2>
          </div>
          <svg id="chevron-medicacion" class="w-6 h-6 text-white/80" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path d="m18 15-6-6-6 6" />
          </svg>
        </button>
        <div id="seccion-medicacion-guardia" class="space-y-3"></div>
      </div>

      <!-- Secci√≥n Tareas -->
      <div>
        <button onclick="toggleSeccion('tareas-guardia')" id="btn-seccion-tareas"
          class="section-btn w-full flex items-center justify-between p-4 rounded-2xl mb-3 bg-gradient-to-r from-sky-400 to-blue-500">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-white/30 rounded-xl backdrop-blur-sm">
              <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
              </svg>
            </div>
            <h2 class="text-xl font-bold text-white tracking-tight">Tareas de Cuidado</h2>
          </div>
          <svg id="chevron-tareas" class="w-6 h-6 text-white/80" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path d="m18 15-6-6-6 6" />
          </svg>
        </button>
        <div id="seccion-tareas-guardia" class="space-y-3"></div>
      </div>

      <!-- Secci√≥n Rotaciones -->
      <div>
        <button onclick="toggleSeccion('rotaciones-guardia')" id="btn-seccion-rotaciones"
          class="section-btn w-full flex items-center justify-between p-4 rounded-2xl mb-3 bg-gradient-to-r from-violet-400 to-purple-500">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-white/30 rounded-xl backdrop-blur-sm">
              <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                <path d="M3 3v5h5" />
              </svg>
            </div>
            <h2 id="titulo-rotaciones" class="text-xl font-bold text-white tracking-tight">Rotaciones (0)</h2>
          </div>
          <svg id="chevron-rotaciones" class="w-6 h-6 text-white/80" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path d="m18 15-6-6-6 6" />
          </svg>
        </button>
        <div id="seccion-rotaciones-guardia" class="rounded-2xl p-4 border"></div>
      </div>
    </div>

    <!-- Bot√≥n Flotante Informe -->
    <div id="footer-guardia" class="fixed bottom-0 left-0 right-0 p-4">
      <div class="max-w-2xl mx-auto">
        <button onclick="mostrarInforme()" id="btn-generar-informe"
          class="w-full py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 font-bold text-lg transition-all text-white">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
          </svg>
          Generar Informe de Guardia
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== PANTALLA INFORME ==================== -->
  <div id="pantalla-informe" class="hidden min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
      <div id="card-informe-header" class="rounded-3xl p-6 mb-4 border">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div id="icono-informe" class="p-3 rounded-2xl">
              <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
              </svg>
            </div>
            <div>
              <h1 id="titulo-informe" class="text-2xl font-black">Informe de Guardia</h1>
              <p id="fecha-informe" class=""></p>
            </div>
          </div>
          <button onclick="volverGuardia()" id="btn-volver-informe"
            class="px-4 py-2 rounded-xl font-semibold transition-all">
            Volver
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <div id="card-paciente" class="p-4 rounded-2xl">
            <p id="label-paciente" class="text-xs font-semibold uppercase tracking-wider">Paciente</p>
            <p id="valor-paciente" class="text-lg font-bold">Patricio Recalde</p>
          </div>
          <div id="card-guardia-info" class="p-4 rounded-2xl">
            <p id="label-guardia-info" class="text-xs font-semibold uppercase tracking-wider">Guardia</p>
            <p id="valor-guardia-info" class="text-lg font-bold"></p>
          </div>
          <div id="card-enfermero" class="p-4 rounded-2xl">
            <p id="label-enfermero" class="text-xs font-semibold uppercase tracking-wider">Enfermero/a</p>
            <p id="valor-enfermero" class="font-bold"></p>
          </div>
          <div id="card-auxiliar" class="p-4 rounded-2xl">
            <p id="label-auxiliar" class="text-xs font-semibold uppercase tracking-wider">Auxiliar</p>
            <p id="valor-auxiliar" class="font-bold"></p>
          </div>
        </div>

        <div class="mb-4">
          <div class="flex justify-between items-center mb-2">
            <span id="label-progreso-informe" class="font-semibold">Progreso General</span>
            <span id="valor-progreso-informe" class="text-2xl font-black">0%</span>
          </div>
          <div id="barra-progreso-informe-bg" class="h-4 rounded-full overflow-hidden">
            <div id="barra-progreso-informe" class="h-full rounded-full transition-all duration-500" style="width: 0%">
            </div>
          </div>
        </div>
      </div>

      <!-- Resumen Medicaci√≥n -->
      <div id="card-resumen-medicacion" class="rounded-2xl p-4 mb-3 border">
        <div class="flex items-center gap-2 mb-3">
          <svg id="icono-med-informe" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path
              d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
          </svg>
          <h3 id="titulo-med-informe" class="font-bold">Medicaci√≥n</h3>
        </div>
        <div id="lista-med-informe" class="space-y-2"></div>
      </div>

      <!-- Resumen Tareas -->
      <div id="card-resumen-tareas" class="rounded-2xl p-4 mb-3 border">
        <div class="flex items-center gap-2 mb-3">
          <svg id="icono-tar-informe" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
          </svg>
          <h3 id="titulo-tar-informe" class="font-bold">Tareas de Cuidado</h3>
        </div>
        <div id="lista-tar-informe" class="grid grid-cols-2 gap-2"></div>
      </div>

      <!-- Resumen Rotaciones -->
      <div id="card-resumen-rotaciones" class="rounded-2xl p-4 mb-3 border">
        <div class="flex items-center gap-2 mb-3">
          <svg id="icono-rot-informe" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
            <path d="M3 3v5h5" />
          </svg>
          <h3 id="titulo-rot-informe" class="font-bold">Rotaciones Realizadas: 0</h3>
        </div>
        <div id="lista-rot-informe" class="space-y-2"></div>
      </div>

      <!-- Resumen Signos Vitales -->
      <div id="card-resumen-sv" class="rounded-2xl p-4 mb-3 border">
        <div class="flex items-center gap-2 mb-3">
          <svg id="icono-sv-informe" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
          </svg>
          <h3 id="titulo-sv-informe" class="font-bold">Signos Vitales</h3>
        </div>
        <div id="lista-sv-informe" class="grid grid-cols-3 gap-2"></div>
      </div>

      <!-- Mensaje Importante para el Administrador -->
      <div id="card-mensaje-importante"
        class="rounded-2xl p-4 mb-4 border border-red-200 bg-gradient-to-r from-red-50 to-orange-50">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xl">‚ö†Ô∏è</span>
          <h3 id="titulo-mensaje" class="font-bold text-red-700">Mensaje Importante para el Administrador</h3>
        </div>
        <p class="text-xs text-red-600 mb-2">Este mensaje se destacar√° en el panel de administraci√≥n</p>
        <textarea id="input-mensaje-importante"
          class="w-full p-3 rounded-xl border-2 border-red-200 outline-none min-h-16 bg-white focus:border-red-400"
          placeholder="Escrib√≠ aqu√≠ cualquier mensaje urgente o importante que necesites comunicar..."></textarea>
      </div>

      <!-- Observaciones -->
      <div id="card-observaciones" class="rounded-2xl p-4 mb-4 border">
        <h3 id="titulo-obs" class="font-bold mb-2">Observaciones</h3>
        <textarea id="input-observaciones" class="w-full p-3 rounded-xl border-2 outline-none min-h-24"
          placeholder="Agregar observaciones relevantes..."></textarea>
      </div>

      <!-- Bot√≥n Enviar -->
      <button onclick="enviarInforme()" id="btn-enviar-informe"
        class="w-full py-4 rounded-2xl text-lg font-bold tracking-wide transition-all duration-300 flex items-center justify-center gap-3 text-white">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path d="m22 2-7 20-4-9-9-4Z" />
          <path d="M22 2 11 13" />
        </svg>
        <span id="texto-btn-enviar">Enviar Informe al Administrador</span>
      </button>
    </div>
  </div>

  <script>
    // ==================== DATOS ====================
    let medicacion = [
      { id: 1, hora: "05:00", medicamentos: [{ nombre: "Omeprazol", dosis: "20 mg", cantidad: "1 comp", observaciones: "En ayunas" }], guardia: "nocturna" },
      { id: 2, hora: "06:00", medicamentos: [{ nombre: "Lorazepam", dosis: "2,5 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Salbutamol", dosis: "4 puff", cantidad: "", observaciones: "Inhalatorio por TQT (ARM)" }], guardia: "nocturna" },
      { id: 3, hora: "08:00", medicamentos: [{ nombre: "Levetiracetam", dosis: "1 g", cantidad: "2 comp", observaciones: "" }, { nombre: "Vigabatrina", dosis: "500 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Oxcarbazepina", dosis: "300 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "√Åcido Valproico", dosis: "500 mg", cantidad: "1 comp", observaciones: "" }], guardia: "diurna" },
      { id: 4, hora: "11:00", medicamentos: [{ nombre: "Cinitaprida", dosis: "1 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Citrato de K", dosis: "1620 mg", cantidad: "1 comp", observaciones: "" }], guardia: "diurna" },
      { id: 5, hora: "12:00", medicamentos: [{ nombre: "Lorazepam", dosis: "2,5 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Salbutamol", dosis: "4 puff", cantidad: "", observaciones: "Inhalatorio por TQT (ARM)" }], guardia: "diurna" },
      { id: 6, hora: "16:00", medicamentos: [{ nombre: "Vigabatrina", dosis: "500 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Oxcarbazepina", dosis: "300 mg", cantidad: "1 comp", observaciones: "" }], guardia: "diurna" },
      { id: 7, hora: "17:00", medicamentos: [{ nombre: "Cinitaprida", dosis: "1 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Citrato de K", dosis: "1620 mg", cantidad: "1 comp", observaciones: "" }], guardia: "diurna" },
      { id: 8, hora: "18:00", medicamentos: [{ nombre: "Lorazepam", dosis: "2,5 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Salbutamol", dosis: "4 puff", cantidad: "", observaciones: "Inhalatorio por TQT (ARM)" }], guardia: "diurna" },
      { id: 9, hora: "20:00", medicamentos: [{ nombre: "Levetiracetam", dosis: "1,5 g", cantidad: "3 comp", observaciones: "" }, { nombre: "Oxcarbazepina", dosis: "450 mg", cantidad: "3 comp", observaciones: "" }, { nombre: "√Åcido Valproico", dosis: "500 mg", cantidad: "1 comp", observaciones: "" }], guardia: "nocturna" },
      { id: 10, hora: "22:00", medicamentos: [{ nombre: "Lorazepam", dosis: "10 mg", cantidad: "4 comp", observaciones: "" }, { nombre: "Cinitaprida", dosis: "1 mg", cantidad: "1 comp", observaciones: "" }], guardia: "nocturna" },
      { id: 11, hora: "00:00", medicamentos: [{ nombre: "Lorazepam", dosis: "2,5 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Vigabatrina", dosis: "500 mg", cantidad: "1 comp", observaciones: "" }, { nombre: "Salbutamol", dosis: "4 puff", cantidad: "", observaciones: "Inhalatorio por TQT (ARM)" }], guardia: "nocturna" },
      { id: 12, hora: "03:00", medicamentos: [{ nombre: "BAREX", dosis: "S/N", cantidad: "", observaciones: "S√≥lo si es necesario - Control catarsis" }], guardia: "nocturna" },
    ];

    let tareas = [
      { id: 1, nombre: "CSV - Control Signos Vitales", horario: "Inicio guardia", detalle: "Pase de guardia en domicilio y revisi√≥n completa de Patricio", guardia: "ambas", tipo: "csv" },
      { id: 12, nombre: "Control de Glucemia en Ayunas", horario: "05:15", detalle: "Realizar despu√©s del Omeprazol, antes de la colaci√≥n. Registrar valor en observaciones", guardia: "nocturna", tipo: "csv" },
      { id: 2, nombre: "Rotaci√≥n Postural", horario: "Cada 2 horas", detalle: "Seg√∫n esquema: Dorsal ‚Üí Lateral Der 30¬∞ ‚Üí Dorsal ‚Üí Lateral Izq 30¬∞. Noche: espaciar si duerme", guardia: "ambas", tipo: "rotacion" },
      { id: 3, nombre: "Hidrataci√≥n por Gastrostom√≠a", horario: "Permanente", detalle: "Agua 2 lt total repartido entre ambas guardias", guardia: "ambas", tipo: "hidratacion" },
      { id: 4, nombre: "Hidrataci√≥n por Boca", horario: "Permanente", detalle: "Gasa humedecida en jugo (suspender si duerme)", guardia: "ambas", tipo: "hidratacion" },
      { id: 5, nombre: "Colaci√≥n (Post Omeprazol)", horario: "06:00", detalle: "T√© con galletitas o vainillas x GTT", guardia: "nocturna", tipo: "alimentacion" },
      { id: 6, nombre: "Desayuno", horario: "10:00", detalle: "Leche con cereales o yogurt", guardia: "diurna", tipo: "alimentacion" },
      { id: 7, nombre: "Ba√±o Completo", horario: "12:00-13:00", detalle: "Higiene y confort. Revisar: boca, lengua, conjuntiva (ojo seco), u√±as manos y pies", guardia: "diurna", tipo: "higiene" },
      { id: 8, nombre: "Almuerzo por Gastrostom√≠a", horario: "Post ba√±o", detalle: "Comida natural (mediod√≠a) - 600 cc x GTT", guardia: "diurna", tipo: "alimentacion" },
      { id: 9, nombre: "Traslado con Gr√∫a al Sill√≥n", horario: "Post ba√±o", detalle: "Incluye cambio de postura. M√°x 4hs en sill√≥n, micro-rotaciones c/30-60 min", guardia: "diurna", tipo: "movilidad" },
      { id: 10, nombre: "Merienda", horario: "17:00", detalle: "Licuado yogur + fruta (variable) - 250 cc x GTT", guardia: "diurna", tipo: "alimentacion" },
      { id: 11, nombre: "Cena por Gastrostom√≠a", horario: "Noche", detalle: "Nutris√≥n - 500 ml x GTT", guardia: "nocturna", tipo: "alimentacion" },
    ];

    let controlesRotacion = [
      { id: 1, nombre: "Sacro" },
      { id: 2, nombre: "Talones" },
      { id: 3, nombre: "Caderas" },
      { id: 4, nombre: "Om√≥platos" },
      { id: 5, nombre: "Orejas" },
      { id: 6, nombre: "TQT visible y libre" },
      { id: 7, nombre: "Circuito ARM sin tracci√≥n" },
    ];

    let guardiaActual = null;
    let enfermero = "";
    let auxiliar = "";
    let medicacionCompletada = {};
    let tareasCompletadas = {};
    let rotacionesRealizadas = [];
    let seccionesExpandidas = { 'medicacion-guardia': true, 'tareas-guardia': true, 'rotaciones-guardia': true };

    // Variables para alarmas
    let alarmasActivas = true;
    let alarmaActual = null;
    let alarmasPospuestas = {};
    let alarmasDisparadas = {};
    let audioContext = null;
    let checkAlarmsInterval = null;

    // ==================== SUPABASE - SINCRONIZACI√ìN DE REPORTES ====================
    // Usa el mismo proyecto Supabase de RAINERO CULINARIA
    // Solo necesit√°s ejecutar el script SQL para crear la tabla 'reportes_guardia'
    const SUPABASE_URL = 'https://dukgjrhyhyxvdqzhthje.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_hdrC91CO7zGc3uoO2MsMVA_6K_CQmgd';

    let supabaseClient = null;

    function initSupabase() {
      try {
        if (typeof supabase !== 'undefined' && SUPABASE_URL && SUPABASE_ANON_KEY) {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('[Supabase] Conectado correctamente');
          return true;
        }
      } catch (e) {
        console.log('[Supabase] No disponible, usando solo localStorage:', e);
      }
      return false;
    }

    // ==================== AUDIO / ALARMAS ====================
    let audioUnlocked = false;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      // Desbloquear para Android/iOS
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      return audioContext;
    }

    // Desbloquear audio con primera interacci√≥n del usuario (necesario para Android)
    function unlockAudio() {
      if (audioUnlocked) return;
      try {
        const ctx = initAudio();
        const buffer = ctx.createBuffer(1, 1, 22050);
        const source = ctx.createBufferSource();
        source.buffer = buffer;
        source.connect(ctx.destination);
        source.start(0);
        audioUnlocked = true;
        console.log('[Audio] Desbloqueado correctamente');
      } catch (e) {
        console.log('[Audio] Error al desbloquear:', e);
      }
    }

    // Agregar listener para desbloquear audio con cualquier interacci√≥n
    document.addEventListener('touchstart', unlockAudio, { once: true });
    document.addEventListener('click', unlockAudio, { once: true });

    // Sonido para MEDICACI√ìN (m√°s urgente, tipo alarma m√©dica - tono rojo/urgente)
    function playMedicacionSound() {
      try {
        const ctx = initAudio();
        if (ctx.state === 'suspended') ctx.resume();
        const now = ctx.currentTime;

        // Crear osciladores para sonido de alarma m√©dica urgente
        for (let i = 0; i < 4; i++) {
          const osc1 = ctx.createOscillator();
          const osc2 = ctx.createOscillator();
          const gain = ctx.createGain();

          osc1.type = 'square'; // M√°s penetrante
          osc2.type = 'sine';
          osc1.frequency.value = 880; // La agudo
          osc2.frequency.value = 698; // Fa

          gain.gain.setValueAtTime(0.35, now + i * 0.5);
          gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.5 + 0.4);

          osc1.connect(gain);
          osc2.connect(gain);
          gain.connect(ctx.destination);

          osc1.start(now + i * 0.5);
          osc2.start(now + i * 0.5);
          osc1.stop(now + i * 0.5 + 0.4);
          osc2.stop(now + i * 0.5 + 0.4);
        }
        console.log('[Audio] Reproduciendo sonido de MEDICACI√ìN');
      } catch (e) {
        console.log('[Audio] Error en medicaci√≥n:', e);
      }
    }

    // Sonido para HIGIENE Y CONFORT (suave, reconfortante - tono azul/spa)
    function playHigieneSound() {
      try {
        const ctx = initAudio();
        if (ctx.state === 'suspended') ctx.resume();
        const now = ctx.currentTime;

        // Sonido tipo spa/relajante pero distintivo
        for (let i = 0; i < 3; i++) {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = 'triangle'; // Onda suave
          // Notas ascendentes suaves: Sol -> La -> Si
          osc.frequency.setValueAtTime(392, now + i * 0.6); // Sol
          osc.frequency.linearRampToValueAtTime(440, now + i * 0.6 + 0.2); // La
          osc.frequency.linearRampToValueAtTime(494, now + i * 0.6 + 0.4); // Si

          gain.gain.setValueAtTime(0.2, now + i * 0.6);
          gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.6 + 0.5);

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start(now + i * 0.6);
          osc.stop(now + i * 0.6 + 0.55);
        }
        console.log('[Audio] Reproduciendo sonido de HIGIENE');
      } catch (e) {
        console.log('[Audio] Error en higiene:', e);
      }
    }

    // Sonido para ROTACI√ìN (distintivo, recordatorio importante - tono violeta)
    function playRotacionSound() {
      try {
        const ctx = initAudio();
        if (ctx.state === 'suspended') ctx.resume();
        const now = ctx.currentTime;

        // Sonido tipo "ding-dong" suave pero claro
        const notas = [523, 392, 523]; // Do - Sol - Do
        notas.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = 'sine';
          osc.frequency.value = freq;

          gain.gain.setValueAtTime(0.25, now + i * 0.35);
          gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.35 + 0.3);

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start(now + i * 0.35);
          osc.stop(now + i * 0.35 + 0.35);
        });
        console.log('[Audio] Reproduciendo sonido de ROTACI√ìN');
      } catch (e) {
        console.log('[Audio] Error en rotaci√≥n:', e);
      }
    }

    // Sonido para TAREAS generales (campana suave)
    function playTareaSound() {
      try {
        const ctx = initAudio();
        if (ctx.state === 'suspended') ctx.resume();
        const now = ctx.currentTime;

        // Sonido de campana suave
        for (let i = 0; i < 2; i++) {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = 'sine';
          osc.frequency.setValueAtTime(523, now + i * 0.4); // Do
          osc.frequency.setValueAtTime(659, now + i * 0.4 + 0.1); // Mi
          osc.frequency.setValueAtTime(784, now + i * 0.4 + 0.2); // Sol

          gain.gain.setValueAtTime(0.2, now + i * 0.4);
          gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.4 + 0.35);

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start(now + i * 0.4);
          osc.stop(now + i * 0.4 + 0.4);
        }
        console.log('[Audio] Reproduciendo sonido de TAREA');
      } catch (e) {
        console.log('[Audio] Error en tarea:', e);
      }
    }

    function toggleAlarmas() {
      alarmasActivas = document.getElementById('alarm-toggle').checked;
      guardarEstado();
    }

    function showAlarmNotification(tipo, titulo, descripcion, id, tipoTarea = null) {
      const notification = document.getElementById('alarm-notification');
      const titleEl = document.getElementById('alarm-title');
      const descEl = document.getElementById('alarm-description');

      // Determinar el tipo de alarma basado en el tipo de tarea
      let alarmClass = tipo;
      let icono = 'üìã';
      let soundFunction = playTareaSound;
      let vibratePattern = [200, 100, 200];

      if (tipo === 'medicacion') {
        alarmClass = 'medicacion';
        icono = 'üíä';
        soundFunction = playMedicacionSound;
        vibratePattern = [200, 100, 200, 100, 200, 100, 200]; // M√°s intenso
      } else if (tipoTarea === 'higiene' || titulo.toLowerCase().includes('higiene') || titulo.toLowerCase().includes('ba√±o')) {
        alarmClass = 'higiene';
        icono = 'üõÅ';
        soundFunction = playHigieneSound;
        vibratePattern = [300, 150, 300]; // Suave
      } else if (tipoTarea === 'rotacion' || titulo.toLowerCase().includes('rotaci')) {
        alarmClass = 'rotacion';
        icono = 'üîÑ';
        soundFunction = playRotacionSound;
        vibratePattern = [250, 100, 250, 100, 250];
      } else if (tipoTarea === 'alimentacion' || titulo.toLowerCase().includes('comida') || titulo.toLowerCase().includes('almuerzo') || titulo.toLowerCase().includes('cena') || titulo.toLowerCase().includes('desayuno')) {
        alarmClass = 'alimentacion';
        icono = 'üçΩÔ∏è';
        soundFunction = playTareaSound;
        vibratePattern = [200, 100, 200];
      }

      notification.className = 'alarm-notification ' + alarmClass;
      titleEl.innerHTML = icono + ' ' + titulo;
      descEl.textContent = descripcion;

      alarmaActual = { tipo: alarmClass, id };
      notification.classList.add('show');

      // Reproducir sonido
      soundFunction();

      // Vibrar si est√° disponible
      if (navigator.vibrate) {
        navigator.vibrate(vibratePattern);
      }

      // Mostrar tambi√©n una alerta visual persistente en el header si est√° en guardia
      mostrarRecordatorioVisual(alarmClass, icono, titulo);
    }

    // Funci√≥n para mostrar recordatorio visual persistente
    let recordatorioTimeout = null;
    function mostrarRecordatorioVisual(tipo, icono, titulo) {
      // Crear o actualizar el recordatorio visual
      let recordatorio = document.getElementById('recordatorio-visual');
      if (!recordatorio) {
        recordatorio = document.createElement('div');
        recordatorio.id = 'recordatorio-visual';
        recordatorio.style.cssText = `
          position: fixed;
          top: 70px;
          left: 50%;
          transform: translateX(-50%);
          padding: 12px 20px;
          border-radius: 16px;
          font-weight: 600;
          font-size: 14px;
          display: flex;
          align-items: center;
          gap: 8px;
          z-index: 9998;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          animation: pulse 2s infinite;
          cursor: pointer;
        `;
        recordatorio.onclick = () => recordatorio.remove();
        document.body.appendChild(recordatorio);
      }

      // Colores seg√∫n tipo
      const colores = {
        medicacion: 'linear-gradient(135deg, #f43f5e, #e11d48)',
        higiene: 'linear-gradient(135deg, #06b6d4, #0891b2)',
        rotacion: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
        alimentacion: 'linear-gradient(135deg, #f59e0b, #d97706)',
        tarea: 'linear-gradient(135deg, #3b82f6, #2563eb)'
      };

      recordatorio.style.background = colores[tipo] || colores.tarea;
      recordatorio.style.color = 'white';
      recordatorio.innerHTML = `${icono} <span>${titulo}</span> <span style="opacity:0.7">‚Ä¢ Toca para cerrar</span>`;

      // Auto-ocultar despu√©s de 30 segundos
      if (recordatorioTimeout) clearTimeout(recordatorioTimeout);
      recordatorioTimeout = setTimeout(() => {
        if (recordatorio) recordatorio.remove();
      }, 30000);
    }

    function dismissAlarm() {
      const notification = document.getElementById('alarm-notification');
      notification.classList.remove('show');
      if (alarmaActual) {
        alarmasDisparadas[alarmaActual.id] = true;
        guardarEstado();
      }
      alarmaActual = null;
    }

    function snoozeAlarm() {
      const notification = document.getElementById('alarm-notification');
      notification.classList.remove('show');
      if (alarmaActual) {
        // Posponer 5 minutos
        alarmasPospuestas[alarmaActual.id] = Date.now() + 5 * 60 * 1000;
        guardarEstado();
      }
      alarmaActual = null;
    }

    function checkAlarms() {
      if (!alarmasActivas || !guardiaActual) return;

      const now = new Date();
      const currentHour = now.getHours().toString().padStart(2, '0');
      const currentMinute = now.getMinutes().toString().padStart(2, '0');
      const currentTime = currentHour + ':' + currentMinute;

      // Revisar medicaci√≥n
      getMedicacionGuardia().forEach(med => {
        const alarmId = 'med-' + med.id;

        // Si ya fue completada o disparada, no alarmar
        if (medicacionCompletada[med.id] || alarmasDisparadas[alarmId]) return;

        // Si est√° pospuesta y no pas√≥ el tiempo, no alarmar
        if (alarmasPospuestas[alarmId] && Date.now() < alarmasPospuestas[alarmId]) return;

        // Comparar hora (con margen de 1 minuto)
        if (med.hora === currentTime || (currentMinute === '00' && med.hora === currentHour + ':00')) {
          const meds = med.medicamentos.map(m => m.nombre).join(', ');
          showAlarmNotification('medicacion', 'Medicaci√≥n - ' + med.hora, meds, alarmId);
        }
      });

      // Revisar tareas con horario espec√≠fico
      getTareasGuardia().forEach(tarea => {
        const alarmId = 'tarea-' + tarea.id;

        if (tareasCompletadas[tarea.id] || alarmasDisparadas[alarmId]) return;
        if (alarmasPospuestas[alarmId] && Date.now() < alarmasPospuestas[alarmId]) return;

        // Solo tareas con horario espec√≠fico (no "Permanente", "Cada 2 horas", etc.)
        const horaMatch = tarea.horario.match(/^(\d{2}):(\d{2})/);
        if (horaMatch && tarea.horario.substring(0, 5) === currentTime) {
          // Pasar el tipo de tarea para usar el sonido correcto
          showAlarmNotification('tarea', tarea.nombre, tarea.detalle, alarmId, tarea.tipo);
        }
      });

      // Recordatorio de rotaci√≥n cada 2 horas
      const rotacionAlarmId = 'rotacion-' + currentHour;
      if (currentMinute === '00' && parseInt(currentHour) % 2 === 0) {
        if (!alarmasDisparadas[rotacionAlarmId]) {
          const ultimaRotacion = rotacionesRealizadas[rotacionesRealizadas.length - 1];
          if (!ultimaRotacion || !ultimaRotacion.hora.startsWith(currentHour)) {
            // Usar tipo rotacion para el sonido espec√≠fico
            showAlarmNotification('tarea', 'Rotaci√≥n Postural', 'Es hora de rotar a Patricio seg√∫n el esquema', rotacionAlarmId, 'rotacion');
          }
        }
      }
    }


    // ==================== PERSISTENCIA (LocalStorage) ====================
    function guardarEstado() {
      if (!guardiaActual) return;

      const estado = {
        guardiaActual,
        enfermero,
        auxiliar,
        medicacionCompletada,
        tareasCompletadas,
        rotacionesRealizadas,
        signosVitales: {
          pa: document.getElementById('sv-pa')?.value || '',
          fc: document.getElementById('sv-fc')?.value || '',
          temp: document.getElementById('sv-temp')?.value || '',
          spo2: document.getElementById('sv-spo2')?.value || '',
          fr: document.getElementById('sv-fr')?.value || '',
          gluc: document.getElementById('sv-gluc')?.value || ''
        },
        alarmasActivas,
        alarmasPospuestas,
        alarmasDisparadas,
        fechaGuardia: new Date().toDateString(),
        timestamp: Date.now()
      };

      localStorage.setItem('recaldeHealthGuardia', JSON.stringify(estado));
      mostrarIndicadorGuardado();
    }

    function cargarEstado() {
      try {
        const guardado = localStorage.getItem('recaldeHealthGuardia');
        if (!guardado) return null;

        const estado = JSON.parse(guardado);

        // Verificar que sea del mismo d√≠a
        if (estado.fechaGuardia !== new Date().toDateString()) {
          // Es de otro d√≠a, limpiar
          localStorage.removeItem('recaldeHealthGuardia');
          return null;
        }

        // Verificar que la guardia a√∫n sea v√°lida (no m√°s de 12 horas)
        const horasTranscurridas = (Date.now() - estado.timestamp) / (1000 * 60 * 60);
        if (horasTranscurridas > 12) {
          localStorage.removeItem('recaldeHealthGuardia');
          return null;
        }

        return estado;
      } catch (e) {
        return null;
      }
    }

    function restaurarEstado(estado) {
      guardiaActual = estado.guardiaActual;
      enfermero = estado.enfermero;
      auxiliar = estado.auxiliar;
      medicacionCompletada = estado.medicacionCompletada || {};
      tareasCompletadas = estado.tareasCompletadas || {};
      rotacionesRealizadas = estado.rotacionesRealizadas || [];
      alarmasActivas = estado.alarmasActivas !== false;
      alarmasPospuestas = estado.alarmasPospuestas || {};
      alarmasDisparadas = estado.alarmasDisparadas || {};

      // Restaurar inputs
      document.getElementById('input-enfermero').value = enfermero;
      document.getElementById('input-auxiliar').value = auxiliar;

      return estado.signosVitales;
    }

    function mostrarIndicadorGuardado() {
      const indicator = document.getElementById('save-indicator');
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 1500);
    }

    function limpiarGuardia() {
      localStorage.removeItem('recaldeHealthGuardia');
      medicacionCompletada = {};
      tareasCompletadas = {};
      rotacionesRealizadas = [];
      alarmasPospuestas = {};
      alarmasDisparadas = {};
    }

    // ==================== FUNCIONES UTILIDAD ====================
    function actualizarHora() {
      const now = new Date();
      const opciones = { weekday: 'long', day: 'numeric', month: 'long' };
      document.getElementById('fecha-actual').textContent = now.toLocaleDateString('es-AR', opciones);
      document.getElementById('hora-actual').textContent = now.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

      if (document.getElementById('hora-guardia')) {
        document.getElementById('hora-guardia').textContent = now.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      }
    }

    function validarFormulario() {
      enfermero = document.getElementById('input-enfermero').value.trim();
      auxiliar = document.getElementById('input-auxiliar').value.trim();

      const btnDiurna = document.getElementById('btn-diurna');
      const btnNocturna = document.getElementById('btn-nocturna');

      if (enfermero && auxiliar) {
        btnDiurna.disabled = false;
        btnDiurna.className = 'p-4 rounded-2xl transition-all duration-300 bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow-lg hover:scale-105 active:scale-95 cursor-pointer';
        btnNocturna.disabled = false;
        btnNocturna.className = 'p-4 rounded-2xl transition-all duration-300 bg-gradient-to-br from-emerald-400 to-green-500 text-white shadow-lg hover:scale-105 active:scale-95 cursor-pointer';
      } else {
        btnDiurna.disabled = true;
        btnDiurna.className = 'p-4 rounded-2xl transition-all duration-300 bg-slate-700 text-slate-500 cursor-not-allowed';
        btnNocturna.disabled = true;
        btnNocturna.className = 'p-4 rounded-2xl transition-all duration-300 bg-slate-700 text-slate-500 cursor-not-allowed';
      }
    }

    function mostrarPantalla(id) {
      ['pantalla-inicio', 'pantalla-login-admin', 'pantalla-admin', 'pantalla-guardia', 'pantalla-informe'].forEach(p => {
        document.getElementById(p).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
    }

    function volverInicio() {
      mostrarPantalla('pantalla-inicio');
      guardiaActual = null;
    }

    function confirmarSalir() {
      const completadas = Object.keys(medicacionCompletada).length + Object.keys(tareasCompletadas).length;
      if (completadas > 0) {
        if (confirm('¬øEst√°s seguro de que quer√©s salir?\n\nLos datos de esta guardia quedar√°n guardados hasta que:\n- Generes el informe, o\n- Termine el d√≠a\n\n¬øSalir ahora?')) {
          if (checkAlarmsInterval) clearInterval(checkAlarmsInterval);
          volverInicio();
        }
      } else {
        if (checkAlarmsInterval) clearInterval(checkAlarmsInterval);
        limpiarGuardia();
        volverInicio();
      }
    }

    // ==================== ADMIN ====================
    function mostrarLoginAdmin() {
      mostrarPantalla('pantalla-login-admin');
    }

    function loginAdmin() {
      const pass = document.getElementById('input-admin-password').value;
      if (pass === 'recalde2024') {
        mostrarPantalla('pantalla-admin');
        renderizarListaMedicacion();
        renderizarListaTareas();
        renderizarListaControles();
      } else {
        alert('Contrase√±a incorrecta');
      }
    }

    function cambiarTabAdmin(tab) {
      ['medicacion', 'tareas', 'rotacion', 'reportes'].forEach(t => {
        document.getElementById('tab-' + t).className = 'flex-1 py-4 flex items-center justify-center gap-2 font-semibold text-slate-500 hover:text-slate-700';
        document.getElementById('content-' + t).classList.add('hidden');
      });
      document.getElementById('tab-' + tab).className = 'flex-1 py-4 flex items-center justify-center gap-2 font-semibold text-violet-600 border-b-2 border-violet-600 bg-violet-50';
      document.getElementById('content-' + tab).classList.remove('hidden');

      // Si es la pesta√±a de reportes, renderizar
      if (tab === 'reportes') {
        renderizarReportesAdmin();
      }
    }

    function renderizarListaMedicacion() {
      const lista = document.getElementById('lista-medicacion');
      lista.innerHTML = medicacion.sort((a, b) => a.hora.localeCompare(b.hora)).map(med => `
        <div class="bg-white rounded-2xl shadow p-4 border-l-4 ${med.guardia === 'diurna' ? 'border-orange-400' : 'border-green-400'}">
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center gap-3">
              <span class="text-2xl font-black ${med.guardia === 'diurna' ? 'text-orange-500' : 'text-green-500'}">${med.hora}</span>
              <span class="text-xs px-2 py-1 rounded-full font-bold ${med.guardia === 'diurna' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}">
                ${med.guardia === 'diurna' ? 'DIURNA' : 'NOCTURNA'}
              </span>
            </div>
            <button onclick="eliminarMedicacion(${med.id})" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all">üóëÔ∏è</button>
          </div>
          <div class="space-y-1">
            ${med.medicamentos.map(m => `
              <div class="flex items-center gap-2 text-sm">
                <span class="font-semibold text-slate-700">${m.nombre}</span>
                <span class="text-slate-500">${m.dosis}</span>
                ${m.cantidad ? `<span class="text-slate-400">(${m.cantidad})</span>` : ''}
                ${m.observaciones ? `<span class="text-xs text-violet-500 italic">- ${m.observaciones}</span>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function agregarMedicacion() {
      const hora = document.getElementById('nuevo-med-hora').value;
      const guardia = document.getElementById('nuevo-med-guardia').value;
      const nombre = document.getElementById('nuevo-med-nombre').value;
      const dosis = document.getElementById('nuevo-med-dosis').value;
      const cantidad = document.getElementById('nuevo-med-cantidad').value;
      const obs = document.getElementById('nuevo-med-obs').value;

      if (hora && nombre) {
        medicacion.push({
          id: Date.now(),
          hora,
          guardia,
          medicamentos: [{ nombre, dosis, cantidad, observaciones: obs }]
        });
        document.getElementById('nuevo-med-hora').value = '';
        document.getElementById('nuevo-med-nombre').value = '';
        document.getElementById('nuevo-med-dosis').value = '';
        document.getElementById('nuevo-med-cantidad').value = '';
        document.getElementById('nuevo-med-obs').value = '';
        renderizarListaMedicacion();
      }
    }

    function eliminarMedicacion(id) {
      medicacion = medicacion.filter(m => m.id !== id);
      renderizarListaMedicacion();
    }

    function renderizarListaTareas() {
      const lista = document.getElementById('lista-tareas');
      lista.innerHTML = tareas.map(t => `
        <div class="bg-white rounded-2xl shadow p-4 border-l-4 ${t.guardia === 'diurna' ? 'border-orange-400' : t.guardia === 'nocturna' ? 'border-green-400' : 'border-violet-400'}">
          <div class="flex justify-between items-start">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <span class="font-bold text-slate-800">${t.nombre}</span>
                <span class="text-xs px-2 py-0.5 rounded-full font-semibold ${t.guardia === 'diurna' ? 'bg-orange-100 text-orange-700' : t.guardia === 'nocturna' ? 'bg-green-100 text-green-700' : 'bg-violet-100 text-violet-700'}">
                  ${t.guardia === 'ambas' ? 'AMBAS' : t.guardia.toUpperCase()}
                </span>
              </div>
              <p class="text-sm text-slate-500">${t.horario}</p>
              <p class="text-xs text-slate-400 mt-1">${t.detalle}</p>
            </div>
            <button onclick="eliminarTarea(${t.id})" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function agregarTarea() {
      const nombre = document.getElementById('nueva-tarea-nombre').value;
      const horario = document.getElementById('nueva-tarea-horario').value;
      const detalle = document.getElementById('nueva-tarea-detalle').value;
      const guardia = document.getElementById('nueva-tarea-guardia').value;
      const tipo = document.getElementById('nueva-tarea-tipo').value;

      if (nombre) {
        tareas.push({ id: Date.now(), nombre, horario, detalle, guardia, tipo });
        document.getElementById('nueva-tarea-nombre').value = '';
        document.getElementById('nueva-tarea-horario').value = '';
        document.getElementById('nueva-tarea-detalle').value = '';
        renderizarListaTareas();
      }
    }

    function eliminarTarea(id) {
      tareas = tareas.filter(t => t.id !== id);
      renderizarListaTareas();
    }

    function renderizarListaControles() {
      const lista = document.getElementById('lista-controles');
      lista.innerHTML = controlesRotacion.map(c => `
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
          <span class="font-medium text-slate-700">${c.nombre}</span>
          <button onclick="eliminarControl(${c.id})" class="text-red-400 hover:text-red-600">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function agregarControl() {
      const input = document.getElementById('nuevo-control');
      if (input.value) {
        controlesRotacion.push({ id: Date.now(), nombre: input.value });
        input.value = '';
        renderizarListaControles();
      }
    }

    function eliminarControl(id) {
      controlesRotacion = controlesRotacion.filter(c => c.id !== id);
      renderizarListaControles();
    }

    async function renderizarReportesAdmin() {
      const reportes = await obtenerReportes();
      const lista = document.getElementById('lista-reportes');
      const sinReportes = document.getElementById('sin-reportes');

      if (reportes.length === 0) {
        lista.innerHTML = '';
        sinReportes.classList.remove('hidden');
        return;
      }

      sinReportes.classList.add('hidden');

      lista.innerHTML = reportes.map(r => {
        const esNocturna = r.guardia === 'nocturna';
        const progreso = r.progreso ? r.progreso.porcentaje : 0;
        const tieneMensajeImportante = r.mensajeImportante && r.mensajeImportante.trim() !== '';
        const noLeido = r.leido === false;

        return `
          <div class="bg-gradient-to-r ${esNocturna ? 'from-emerald-50 to-teal-50 border-emerald-200' : 'from-amber-50 to-orange-50 border-amber-200'} rounded-2xl p-4 border ${noLeido ? 'ring-2 ring-blue-400 ring-offset-2' : ''}">
            ${noLeido ? '<div class="flex items-center gap-2 mb-2"><span class="px-2 py-1 bg-blue-500 text-white text-xs font-bold rounded-full animate-pulse">üÜï NUEVO</span></div>' : ''}
            
            ${tieneMensajeImportante ? `
            <div class="bg-red-100 border-2 border-red-300 rounded-xl p-3 mb-3">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-lg">‚ö†Ô∏è</span>
                <span class="font-bold text-red-700 text-sm">MENSAJE IMPORTANTE</span>
              </div>
              <p class="text-red-800 font-medium">${r.mensajeImportante}</p>
            </div>
            ` : ''}
            
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-2xl">${esNocturna ? 'üåô' : '‚òÄÔ∏è'}</span>
                  <span class="font-bold text-lg text-slate-800">${r.guardiaTexto || r.guardia}</span>
                  <span class="px-2 py-1 rounded-lg text-xs font-bold ${progreso >= 80 ? 'bg-emerald-100 text-emerald-700' : progreso >= 50 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">
                    ${progreso}% completado
                  </span>
                </div>
                <p class="text-sm text-slate-600">${r.fecha}</p>
              </div>
              <div class="flex gap-1">
                ${noLeido ? `<button onclick="marcarComoLeido(${r.id})" class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all" title="Marcar como le√≠do">‚úì</button>` : ''}
                <button onclick="eliminarReporte(${r.id})" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all" title="Eliminar reporte">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div class="bg-white/70 rounded-xl p-3">
                <p class="text-xs text-slate-500 font-semibold">Enfermero/a</p>
                <p class="font-bold text-slate-800">${r.enfermero}</p>
              </div>
              <div class="bg-white/70 rounded-xl p-3">
                <p class="text-xs text-slate-500 font-semibold">Auxiliar</p>
                <p class="font-bold text-slate-800">${r.auxiliar}</p>
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-3">
              <div class="bg-white/70 rounded-xl p-2 text-center">
                <p class="text-xs text-slate-500">Medicaci√≥n</p>
                <p class="font-bold ${r.progreso && r.progreso.medicacion.completadas === r.progreso.medicacion.total ? 'text-emerald-600' : 'text-slate-700'}">
                  ${r.progreso ? r.progreso.medicacion.completadas : '?'}/${r.progreso ? r.progreso.medicacion.total : '?'}
                </p>
              </div>
              <div class="bg-white/70 rounded-xl p-2 text-center">
                <p class="text-xs text-slate-500">Tareas</p>
                <p class="font-bold ${r.progreso && r.progreso.tareas.completadas === r.progreso.tareas.total ? 'text-emerald-600' : 'text-slate-700'}">
                  ${r.progreso ? r.progreso.tareas.completadas : '?'}/${r.progreso ? r.progreso.tareas.total : '?'}
                </p>
              </div>
              <div class="bg-white/70 rounded-xl p-2 text-center">
                <p class="text-xs text-slate-500">Rotaciones</p>
                <p class="font-bold text-slate-700">${r.progreso ? r.progreso.rotaciones : (r.rotacionesRealizadas ? r.rotacionesRealizadas.length : 0)}</p>
              </div>
            </div>
            
            ${r.signosVitales ? `
            <div class="bg-white/70 rounded-xl p-3 mb-3">
              <p class="text-xs text-slate-500 font-semibold mb-2">Signos Vitales</p>
              <div class="flex flex-wrap gap-2">
                ${r.signosVitales.pa ? `<span class="px-2 py-1 bg-slate-100 rounded text-xs"><b>PA:</b> ${r.signosVitales.pa}</span>` : ''}
                ${r.signosVitales.fc ? `<span class="px-2 py-1 bg-slate-100 rounded text-xs"><b>FC:</b> ${r.signosVitales.fc}</span>` : ''}
                ${r.signosVitales.temp ? `<span class="px-2 py-1 bg-slate-100 rounded text-xs"><b>T¬∞:</b> ${r.signosVitales.temp}</span>` : ''}
                ${r.signosVitales.spo2 ? `<span class="px-2 py-1 bg-slate-100 rounded text-xs"><b>SpO2:</b> ${r.signosVitales.spo2}</span>` : ''}
                ${r.signosVitales.fr ? `<span class="px-2 py-1 bg-slate-100 rounded text-xs"><b>FR:</b> ${r.signosVitales.fr}</span>` : ''}
                ${r.signosVitales.gluc ? `<span class="px-2 py-1 bg-rose-100 rounded text-xs"><b>Gluc:</b> ${r.signosVitales.gluc}</span>` : ''}
              </div>
            </div>
            ` : ''}
            
            ${r.observaciones ? `
            <div class="bg-white/70 rounded-xl p-3 mb-3">
              <p class="text-xs text-slate-500 font-semibold mb-1">Observaciones</p>
              <p class="text-sm text-slate-700">${r.observaciones}</p>
            </div>
            ` : ''}
            
            <button onclick="verDetalleReporte(${r.id})" class="w-full py-2 bg-white/80 hover:bg-white rounded-xl text-sm font-semibold text-slate-600 transition-all">
              üìã Ver detalle completo
            </button>
          </div>
        `;
      }).join('');
    }

    function verDetalleReporte(id) {
      const reportes = obtenerReportes();
      const r = reportes.find(rep => rep.id === id);
      if (!r) return;

      let detalle = `REPORTE DE GUARDIA\n`;
      detalle += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
      detalle += `üìÖ Fecha: ${r.fecha}\n`;
      detalle += `üè• Guardia: ${r.guardiaTexto || r.guardia}\n`;
      detalle += `üë®‚Äç‚öïÔ∏è Enfermero/a: ${r.enfermero}\n`;
      detalle += `üë©‚Äç‚öïÔ∏è Auxiliar: ${r.auxiliar}\n`;
      detalle += `üìä Progreso: ${r.progreso ? r.progreso.porcentaje : 0}%\n\n`;

      detalle += `SIGNOS VITALES\n`;
      detalle += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      if (r.signosVitales) {
        detalle += `PA: ${r.signosVitales.pa || '-'} | FC: ${r.signosVitales.fc || '-'} | T¬∞: ${r.signosVitales.temp || '-'}\n`;
        detalle += `SpO2: ${r.signosVitales.spo2 || '-'} | FR: ${r.signosVitales.fr || '-'} | Gluc: ${r.signosVitales.gluc || '-'}\n\n`;
      }

      detalle += `MEDICACI√ìN\n`;
      detalle += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      if (r.medicacionDetalle) {
        r.medicacionDetalle.forEach(m => {
          detalle += `${m.completado ? '‚úÖ' : '‚ùå'} ${m.hora} - ${m.medicamentos}`;
          if (m.horaCompletado) detalle += ` (a las ${m.horaCompletado})`;
          detalle += `\n`;
        });
      }
      detalle += `\n`;

      detalle += `TAREAS\n`;
      detalle += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      if (r.tareasDetalle) {
        r.tareasDetalle.forEach(t => {
          detalle += `${t.completado ? '‚úÖ' : '‚ùå'} ${t.nombre}`;
          if (t.horaCompletado) detalle += ` (a las ${t.horaCompletado})`;
          detalle += `\n`;
        });
      }
      detalle += `\n`;

      detalle += `ROTACIONES: ${r.rotacionesRealizadas ? r.rotacionesRealizadas.length : 0}\n`;
      detalle += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      if (r.rotacionesRealizadas && r.rotacionesRealizadas.length > 0) {
        r.rotacionesRealizadas.forEach((rot, i) => {
          detalle += `${i + 1}. ${rot.hora} - ${rot.posicion}\n`;
        });
      }
      detalle += `\n`;

      if (r.observaciones) {
        detalle += `OBSERVACIONES\n`;
        detalle += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
        detalle += `${r.observaciones}\n`;
      }

      alert(detalle);
    }

    function exportarReportesCSV() {
      const reportes = obtenerReportes();
      if (reportes.length === 0) {
        alert('No hay reportes para exportar');
        return;
      }

      // Crear CSV
      let csv = 'Fecha,Guardia,Enfermero,Auxiliar,Progreso,Med Completadas,Med Total,Tareas Completadas,Tareas Total,Rotaciones,PA,FC,Temp,SpO2,FR,Glucemia,Observaciones\n';

      reportes.forEach(r => {
        const prog = r.progreso || {};
        const sv = r.signosVitales || {};
        const obs = (r.observaciones || '').replace(/"/g, '""').replace(/\n/g, ' ');

        csv += `"${r.fecha}",`;
        csv += `"${r.guardiaTexto || r.guardia}",`;
        csv += `"${r.enfermero}",`;
        csv += `"${r.auxiliar}",`;
        csv += `${prog.porcentaje || 0}%,`;
        csv += `${prog.medicacion ? prog.medicacion.completadas : 0},`;
        csv += `${prog.medicacion ? prog.medicacion.total : 0},`;
        csv += `${prog.tareas ? prog.tareas.completadas : 0},`;
        csv += `${prog.tareas ? prog.tareas.total : 0},`;
        csv += `${prog.rotaciones || 0},`;
        csv += `"${sv.pa || ''}",`;
        csv += `"${sv.fc || ''}",`;
        csv += `"${sv.temp || ''}",`;
        csv += `"${sv.spo2 || ''}",`;
        csv += `"${sv.fr || ''}",`;
        csv += `"${sv.gluc || ''}",`;
        csv += `"${obs}"\n`;
      });

      // Descargar
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `reportes_recalde_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // ==================== GUARDIA ====================
    function iniciarGuardia(tipo, signosVitalesRestaurados = null) {
      guardiaActual = tipo;

      // Si no hay datos restaurados, limpiar todo
      if (!signosVitalesRestaurados) {
        medicacionCompletada = {};
        tareasCompletadas = {};
        rotacionesRealizadas = [];
        alarmasPospuestas = {};
        alarmasDisparadas = {};
      }

      mostrarPantalla('pantalla-guardia');
      aplicarEstilosGuardia(tipo);
      renderizarGuardia();

      // Restaurar signos vitales si existen
      if (signosVitalesRestaurados) {
        document.getElementById('sv-pa').value = signosVitalesRestaurados.pa || '';
        document.getElementById('sv-fc').value = signosVitalesRestaurados.fc || '';
        document.getElementById('sv-temp').value = signosVitalesRestaurados.temp || '';
        document.getElementById('sv-spo2').value = signosVitalesRestaurados.spo2 || '';
        document.getElementById('sv-fr').value = signosVitalesRestaurados.fr || '';
        document.getElementById('sv-gluc').value = signosVitalesRestaurados.gluc || '';
      }

      // Configurar toggle de alarmas
      document.getElementById('alarm-toggle').checked = alarmasActivas;

      // Iniciar chequeo de alarmas cada 30 segundos
      if (checkAlarmsInterval) clearInterval(checkAlarmsInterval);
      checkAlarmsInterval = setInterval(checkAlarms, 30000);

      // Guardar estado inicial
      guardarEstado();

      // Agregar listeners para guardar signos vitales
      ['sv-pa', 'sv-fc', 'sv-temp', 'sv-spo2', 'sv-fr', 'sv-gluc'].forEach(id => {
        document.getElementById(id).addEventListener('change', guardarEstado);
      });
    }

    function aplicarEstilosGuardia(tipo) {
      const esNocturna = tipo === 'nocturna';
      const pantallaGuardia = document.getElementById('pantalla-guardia');

      if (esNocturna) {
        pantallaGuardia.className = 'min-h-screen bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900';
        document.getElementById('header-guardia').className = 'sticky top-0 z-50 p-4 bg-emerald-900/90 backdrop-blur-xl border-b border-emerald-700/50';
        document.getElementById('logo-guardia').className = 'p-2 rounded-xl shadow-lg bg-gradient-to-br from-emerald-400 to-teal-500';
        document.getElementById('titulo-guardia').className = 'text-lg font-black text-white';
        document.getElementById('subtitulo-guardia').className = 'text-xs font-semibold text-emerald-300';
        document.getElementById('btn-home-guardia').className = 'px-3 py-2 rounded-xl flex items-center gap-1.5 font-semibold text-sm bg-white/10 text-white hover:bg-white/20';
        document.getElementById('alarm-toggle-container').className = 'alarm-toggle';
        document.getElementById('alarm-toggle-label').className = 'text-xs font-semibold text-emerald-200';
        document.getElementById('badge-hora-guardia').className = 'px-3 py-1.5 rounded-xl flex items-center gap-2 bg-emerald-500/30';
        document.getElementById('icono-guardia').innerHTML = '<svg class="w-4 h-4 text-emerald-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
        document.getElementById('hora-guardia').className = 'text-sm font-bold text-emerald-200';
        document.getElementById('info-personal-guardia').className = 'flex items-center gap-4 mt-3 text-xs text-emerald-200';
        document.getElementById('label-progreso').className = 'text-xs font-semibold text-emerald-300';
        document.getElementById('valor-progreso').className = 'text-sm font-black text-emerald-400';
        document.getElementById('barra-progreso-bg').className = 'h-2 rounded-full overflow-hidden bg-white/10';
        document.getElementById('barra-progreso').className = 'h-full rounded-full transition-all duration-500 bg-gradient-to-r from-emerald-400 to-teal-400';
        document.getElementById('card-signos-vitales').className = 'rounded-3xl p-4 border bg-white/10 backdrop-blur-xl border-white/20';
        document.getElementById('icono-sv').className = 'p-2 rounded-xl bg-red-500/30';
        document.getElementById('titulo-sv').className = 'text-lg font-bold text-white';
        document.getElementById('subtitulo-sv').className = 'text-xs text-slate-400';
        document.getElementById('footer-guardia').className = 'fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-emerald-900 via-emerald-900 to-transparent';
        document.getElementById('btn-generar-informe').className = 'w-full py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 font-bold text-lg transition-all text-white bg-gradient-to-r from-emerald-400 to-teal-400';
        document.getElementById('seccion-rotaciones-guardia').className = 'rounded-2xl p-4 border bg-white/10 backdrop-blur-xl border-white/20';

        // Inputs
        ['sv-pa', 'sv-fc', 'sv-temp', 'sv-spo2', 'sv-fr', 'sv-gluc'].forEach(id => {
          document.getElementById(id).className = 'w-full px-2 py-2 text-center text-sm rounded-xl border outline-none bg-white/5 border-white/20 text-white placeholder-slate-500';
        });
        ['label-pa', 'label-fc', 'label-temp', 'label-spo2', 'label-fr', 'label-gluc'].forEach(id => {
          document.getElementById(id).className = 'text-xs font-semibold block text-center mb-1 text-slate-400';
        });
      } else {
        pantallaGuardia.className = 'min-h-screen bg-gradient-to-br from-amber-100 via-orange-50 to-yellow-50';
        document.getElementById('header-guardia').className = 'sticky top-0 z-50 p-4 bg-white/90 backdrop-blur-xl border-b border-slate-200/50 shadow-sm';
        document.getElementById('logo-guardia').className = 'p-2 rounded-xl shadow-lg bg-gradient-to-br from-amber-400 to-orange-500';
        document.getElementById('titulo-guardia').className = 'text-lg font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-600 to-orange-600';
        document.getElementById('subtitulo-guardia').className = 'text-xs font-semibold text-slate-500';
        document.getElementById('btn-home-guardia').className = 'px-3 py-2 rounded-xl flex items-center gap-1.5 font-semibold text-sm bg-slate-100 text-slate-600 hover:bg-slate-200';
        document.getElementById('alarm-toggle-container').className = 'alarm-toggle bg-slate-100';
        document.getElementById('alarm-toggle-label').className = 'text-xs font-semibold text-slate-600';
        document.getElementById('badge-hora-guardia').className = 'px-3 py-1.5 rounded-xl flex items-center gap-2 bg-amber-100';
        document.getElementById('icono-guardia').innerHTML = '<svg class="w-4 h-4 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>';
        document.getElementById('hora-guardia').className = 'text-sm font-bold text-amber-700';
        document.getElementById('info-personal-guardia').className = 'flex items-center gap-4 mt-3 text-xs text-slate-500';
        document.getElementById('label-progreso').className = 'text-xs font-semibold text-slate-500';
        document.getElementById('valor-progreso').className = 'text-sm font-black text-amber-600';
        document.getElementById('barra-progreso-bg').className = 'h-2 rounded-full overflow-hidden bg-slate-200';
        document.getElementById('barra-progreso').className = 'h-full rounded-full transition-all duration-500 bg-gradient-to-r from-amber-400 to-orange-500';
        document.getElementById('card-signos-vitales').className = 'rounded-3xl p-4 border bg-white shadow-xl border-slate-100';
        document.getElementById('icono-sv').className = 'p-2 rounded-xl bg-gradient-to-br from-red-400 to-rose-500';
        document.getElementById('titulo-sv').className = 'text-lg font-bold text-slate-800';
        document.getElementById('subtitulo-sv').className = 'text-xs text-slate-500';
        document.getElementById('footer-guardia').className = 'fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent';
        document.getElementById('btn-generar-informe').className = 'w-full py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 font-bold text-lg transition-all text-white bg-gradient-to-r from-amber-400 to-orange-500';
        document.getElementById('seccion-rotaciones-guardia').className = 'rounded-2xl p-4 border bg-white shadow-lg border-slate-100';

        // Inputs
        ['sv-pa', 'sv-fc', 'sv-temp', 'sv-spo2', 'sv-fr', 'sv-gluc'].forEach(id => {
          document.getElementById(id).className = 'w-full px-2 py-2 text-center text-sm rounded-xl border outline-none border-slate-200 focus:border-amber-400';
        });
        ['label-pa', 'label-fc', 'label-temp', 'label-spo2', 'label-fr', 'label-gluc'].forEach(id => {
          document.getElementById(id).className = 'text-xs font-semibold block text-center mb-1 text-slate-500';
        });
      }

      document.getElementById('info-personal-guardia').innerHTML = `
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
          </svg>
          <span class="font-semibold">${enfermero}</span>
        </div>
        <div class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <span class="font-semibold">${auxiliar}</span>
        </div>
      `;
    }

    function renderizarGuardia() {
      renderizarMedicacionGuardia();
      renderizarTareasGuardia();
      renderizarRotacionesGuardia();
      actualizarProgreso();
    }

    // Funci√≥n auxiliar para ordenar horas seg√∫n el tipo de guardia
    function ordenarPorHoraGuardia(a, b) {
      // Convertir hora "HH:MM" a n√∫mero para comparar
      const horaA = parseInt(a.hora.split(':')[0]);
      const horaB = parseInt(b.hora.split(':')[0]);

      // Para guardia nocturna (20:00 - 08:00), las horas de 20-23 van primero
      // luego las horas de 00-08
      if (guardiaActual === 'nocturna') {
        // Si una hora es >= 20 y otra < 20, la >= 20 va primero
        const aEsTarde = horaA >= 20;
        const bEsTarde = horaB >= 20;

        if (aEsTarde && !bEsTarde) return -1; // a va primero
        if (!aEsTarde && bEsTarde) return 1;  // b va primero
      }

      // Si ambas est√°n en el mismo "per√≠odo", ordenar normalmente
      return a.hora.localeCompare(b.hora);
    }

    function getMedicacionGuardia() {
      return medicacion
        .filter(m => m.guardia === guardiaActual)
        .sort(ordenarPorHoraGuardia);
    }

    function getTareasGuardia() {
      return tareas.filter(t => t.guardia === guardiaActual || t.guardia === 'ambas');
    }

    function renderizarMedicacionGuardia() {
      const esNocturna = guardiaActual === 'nocturna';
      const lista = document.getElementById('seccion-medicacion-guardia');
      const meds = getMedicacionGuardia();

      lista.innerHTML = meds.map(med => {
        const completado = medicacionCompletada[med.id];
        return `
          <div class="${esNocturna ? 'bg-white/10 backdrop-blur-xl border-white/20' : 'bg-white shadow-lg border-slate-100'} rounded-2xl p-4 border">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-2xl font-black ${esNocturna ? 'text-emerald-400' : 'text-amber-500'}">${med.hora}</span>
                  ${completado ? `<span class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded-lg font-semibold">‚úì ${completado}</span>` : ''}
                </div>
                <div class="space-y-1">
                  ${med.medicamentos.map(m => `
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 rounded-full ${esNocturna ? 'bg-emerald-400' : 'bg-amber-400'}"></div>
                      <span class="font-semibold ${esNocturna ? 'text-white' : 'text-slate-800'}">${m.nombre}</span>
                      <span class="${esNocturna ? 'text-slate-400' : 'text-slate-500'}">${m.dosis}</span>
                      ${m.cantidad ? `<span class="${esNocturna ? 'text-slate-500' : 'text-slate-400'}">(${m.cantidad})</span>` : ''}
                    </div>
                  `).join('')}
                  ${med.medicamentos.some(m => m.observaciones) ? `
                    <p class="text-xs mt-2 px-2 py-1 rounded-lg ${esNocturna ? 'bg-violet-500/20 text-violet-300' : 'bg-violet-50 text-violet-600'}">
                      ${med.medicamentos.filter(m => m.observaciones).map(m => m.observaciones).join(' | ')}
                    </p>
                  ` : ''}
                </div>
              </div>
              <button onclick="toggleMedicacion(${med.id})" class="check-btn w-12 h-12 rounded-2xl flex items-center justify-center ${completado
            ? 'bg-gradient-to-br from-emerald-400 to-teal-500 text-white shadow-lg'
            : 'bg-white border-2 border-dashed border-slate-300 text-slate-400 hover:border-slate-400'
          }">
                ${completado ? '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' : ''}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderizarTareasGuardia() {
      const esNocturna = guardiaActual === 'nocturna';
      const lista = document.getElementById('seccion-tareas-guardia');
      const tars = getTareasGuardia();

      lista.innerHTML = tars.map(t => {
        const completado = tareasCompletadas[t.id];
        return `
          <div class="${esNocturna ? 'bg-white/10 backdrop-blur-xl border-white/20' : 'bg-white shadow-lg border-slate-100'} rounded-2xl p-4 border flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-bold ${esNocturna ? 'text-white' : 'text-slate-800'}">${t.nombre}</span>
                ${completado ? `<span class="text-xs px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-lg font-semibold">‚úì ${completado}</span>` : ''}
              </div>
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs px-2 py-1 rounded-lg font-semibold ${esNocturna ? 'bg-sky-500/30 text-sky-200' : 'bg-sky-100 text-sky-700'}">${t.horario}</span>
                ${t.guardia === 'ambas' ? `<span class="text-xs px-2 py-1 rounded-lg font-semibold ${esNocturna ? 'bg-violet-500/30 text-violet-200' : 'bg-violet-100 text-violet-700'}">Ambas guardias</span>` : ''}
              </div>
              <p class="text-sm ${esNocturna ? 'text-slate-400' : 'text-slate-500'}">${t.detalle}</p>
            </div>
            <button onclick="toggleTarea(${t.id})" class="check-btn w-12 h-12 rounded-2xl flex items-center justify-center ${completado
            ? 'bg-gradient-to-br from-emerald-400 to-teal-500 text-white shadow-lg'
            : 'bg-white border-2 border-dashed border-slate-300 text-slate-400 hover:border-slate-400'
          }">
              ${completado ? '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' : ''}
            </button>
          </div>
        `;
      }).join('');
    }

    function renderizarRotacionesGuardia() {
      const esNocturna = guardiaActual === 'nocturna';
      const container = document.getElementById('seccion-rotaciones-guardia');

      document.getElementById('titulo-rotaciones').textContent = `Rotaciones (${rotacionesRealizadas.length})`;

      container.innerHTML = `
        <p class="text-sm mb-4 ${esNocturna ? 'text-slate-300' : 'text-slate-600'}">
          Registrar cada rotaci√≥n realizada. Secuencia: Dorsal ‚Üí Lateral Der 30¬∞ ‚Üí Dorsal ‚Üí Lateral Izq 30¬∞
        </p>
        <div class="grid grid-cols-2 gap-2 mb-4">
          ${['Dec√∫bito Dorsal', 'Lateral Derecho 30¬∞', 'Lateral Izquierdo 30¬∞', 'Sentado en Sill√≥n'].map(pos => `
            <button onclick="agregarRotacion('${pos}')" class="p-3 rounded-xl font-semibold text-sm transition-all ${esNocturna
          ? 'bg-violet-500/30 text-violet-200 hover:bg-violet-500/50 active:scale-95'
          : 'bg-violet-100 text-violet-700 hover:bg-violet-200 active:scale-95'
        }">
              ${pos}
            </button>
          `).join('')}
        </div>
        ${rotacionesRealizadas.length > 0 ? `
          <div class="space-y-2 mb-4">
            <h4 class="font-semibold text-sm ${esNocturna ? 'text-slate-300' : 'text-slate-600'}">Historial:</h4>
            ${rotacionesRealizadas.map((r, idx) => `
              <div class="flex items-center justify-between p-2 rounded-xl ${esNocturna ? 'bg-white/5' : 'bg-slate-50'}">
                <div class="flex items-center gap-2">
                  <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold bg-violet-500 text-white">${idx + 1}</span>
                  <span class="font-medium ${esNocturna ? 'text-white' : 'text-slate-800'}">${r.posicion}</span>
                </div>
                <span class="${esNocturna ? 'text-slate-400' : 'text-slate-500'}">${r.hora}</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
        <div class="p-3 rounded-xl ${esNocturna ? 'bg-amber-500/20' : 'bg-amber-50'}">
          <p class="text-xs font-semibold mb-2 ${esNocturna ? 'text-amber-300' : 'text-amber-700'}">
            ‚ö†Ô∏è Verificar en cada rotaci√≥n:
          </p>
          <div class="flex flex-wrap gap-1">
            ${controlesRotacion.map(c => `
              <span class="text-xs px-2 py-1 rounded-lg ${esNocturna ? 'bg-white/10 text-slate-300' : 'bg-white text-slate-600'}">${c.nombre}</span>
            `).join('')}
          </div>
        </div>
      `;
    }

    function toggleMedicacion(id) {
      if (medicacionCompletada[id]) {
        delete medicacionCompletada[id];
      } else {
        medicacionCompletada[id] = new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      }
      renderizarMedicacionGuardia();
      actualizarProgreso();
      guardarEstado();
    }

    function toggleTarea(id) {
      if (tareasCompletadas[id]) {
        delete tareasCompletadas[id];
      } else {
        tareasCompletadas[id] = new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      }
      renderizarTareasGuardia();
      actualizarProgreso();
      guardarEstado();
    }

    function agregarRotacion(posicion) {
      rotacionesRealizadas.push({
        id: Date.now(),
        posicion,
        hora: new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })
      });
      renderizarRotacionesGuardia();
      guardarEstado();
    }

    function toggleSeccion(id) {
      const seccion = document.getElementById('seccion-' + id);
      const chevron = document.getElementById('chevron-' + id.replace('-guardia', ''));
      seccionesExpandidas[id] = !seccionesExpandidas[id];

      if (seccionesExpandidas[id]) {
        seccion.classList.remove('hidden');
        chevron.innerHTML = '<path d="m18 15-6-6-6 6"/>';
      } else {
        seccion.classList.add('hidden');
        chevron.innerHTML = '<path d="m6 9 6 6 6-6"/>';
      }
    }

    function actualizarProgreso() {
      const meds = getMedicacionGuardia();
      const tars = getTareasGuardia();
      const totalMed = meds.length;
      const totalTar = tars.length;
      const completadasMed = Object.keys(medicacionCompletada).filter(k => meds.some(m => m.id == k)).length;
      const completadasTar = Object.keys(tareasCompletadas).filter(k => tars.some(t => t.id == k)).length;
      const total = totalMed + totalTar;
      const completadas = completadasMed + completadasTar;
      const progreso = total > 0 ? Math.round((completadas / total) * 100) : 0;

      document.getElementById('valor-progreso').textContent = progreso + '%';
      document.getElementById('barra-progreso').style.width = progreso + '%';
    }

    // ==================== INFORME ====================
    function mostrarInforme() {
      mostrarPantalla('pantalla-informe');
      aplicarEstilosInforme();
      renderizarInforme();
    }

    function volverGuardia() {
      mostrarPantalla('pantalla-guardia');
    }

    function aplicarEstilosInforme() {
      const esNocturna = guardiaActual === 'nocturna';
      const pantalla = document.getElementById('pantalla-informe');

      if (esNocturna) {
        pantalla.className = 'min-h-screen p-4 bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900';
        document.getElementById('card-informe-header').className = 'rounded-3xl p-6 mb-4 border bg-white/10 backdrop-blur-xl border-white/20';
        document.getElementById('icono-informe').className = 'p-3 rounded-2xl bg-emerald-500';
        document.getElementById('titulo-informe').className = 'text-2xl font-black text-white';
        document.getElementById('fecha-informe').className = 'text-emerald-300';
        document.getElementById('btn-volver-informe').className = 'px-4 py-2 rounded-xl font-semibold transition-all bg-white/20 text-white hover:bg-white/30';
        document.getElementById('card-paciente').className = 'p-4 rounded-2xl bg-white/10';
        document.getElementById('label-paciente').className = 'text-xs font-semibold uppercase tracking-wider text-emerald-300';
        document.getElementById('valor-paciente').className = 'text-lg font-bold text-white';
        document.getElementById('card-guardia-info').className = 'p-4 rounded-2xl bg-emerald-500/30';
        document.getElementById('label-guardia-info').className = 'text-xs font-semibold uppercase tracking-wider text-emerald-200';
        document.getElementById('valor-guardia-info').className = 'text-lg font-bold text-white';
        document.getElementById('card-enfermero').className = 'p-4 rounded-2xl bg-white/5';
        document.getElementById('label-enfermero').className = 'text-xs font-semibold uppercase tracking-wider text-slate-400';
        document.getElementById('valor-enfermero').className = 'font-bold text-white';
        document.getElementById('card-auxiliar').className = 'p-4 rounded-2xl bg-white/5';
        document.getElementById('label-auxiliar').className = 'text-xs font-semibold uppercase tracking-wider text-slate-400';
        document.getElementById('valor-auxiliar').className = 'font-bold text-white';
        document.getElementById('label-progreso-informe').className = 'font-semibold text-slate-300';
        document.getElementById('valor-progreso-informe').className = 'text-2xl font-black text-emerald-400';
        document.getElementById('barra-progreso-informe-bg').className = 'h-4 rounded-full overflow-hidden bg-white/10';
        document.getElementById('barra-progreso-informe').className = 'h-full rounded-full transition-all duration-500 bg-gradient-to-r from-emerald-400 to-teal-400';
        document.getElementById('card-resumen-medicacion').className = 'rounded-2xl p-4 mb-3 border bg-white/10 backdrop-blur-xl border-white/20';
        document.getElementById('icono-med-informe').className = 'w-5 h-5 text-rose-400';
        document.getElementById('titulo-med-informe').className = 'font-bold text-white';
        document.getElementById('card-resumen-tareas').className = 'rounded-2xl p-4 mb-3 border bg-white/10 backdrop-blur-xl border-white/20';
        document.getElementById('icono-tar-informe').className = 'w-5 h-5 text-sky-400';
        document.getElementById('titulo-tar-informe').className = 'font-bold text-white';
        document.getElementById('card-resumen-rotaciones').className = 'rounded-2xl p-4 mb-3 border bg-white/10 backdrop-blur-xl border-white/20';
        document.getElementById('icono-rot-informe').className = 'w-5 h-5 text-violet-400';
        document.getElementById('titulo-rot-informe').className = 'font-bold text-white';
        document.getElementById('card-resumen-sv').className = 'rounded-2xl p-4 mb-3 border bg-white/10 backdrop-blur-xl border-white/20';
        document.getElementById('icono-sv-informe').className = 'w-5 h-5 text-red-400';
        document.getElementById('titulo-sv-informe').className = 'font-bold text-white';
        document.getElementById('card-observaciones').className = 'rounded-2xl p-4 mb-4 border bg-white/10 backdrop-blur-xl border-white/20';
        document.getElementById('titulo-obs').className = 'font-bold text-white mb-2';
        document.getElementById('input-observaciones').className = 'w-full p-3 rounded-xl border-2 outline-none min-h-24 bg-white/5 border-white/20 text-white placeholder-slate-400';
        document.getElementById('btn-enviar-informe').className = 'w-full py-4 rounded-2xl text-lg font-bold tracking-wide transition-all duration-300 flex items-center justify-center gap-3 text-white bg-gradient-to-r from-emerald-400 to-teal-400 shadow-lg';
      } else {
        pantalla.className = 'min-h-screen p-4 bg-gradient-to-br from-amber-100 via-orange-50 to-yellow-50';
        document.getElementById('card-informe-header').className = 'rounded-3xl p-6 mb-4 border bg-white shadow-xl border-slate-100';
        document.getElementById('icono-informe').className = 'p-3 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500';
        document.getElementById('titulo-informe').className = 'text-2xl font-black text-slate-800';
        document.getElementById('fecha-informe').className = 'text-slate-500';
        document.getElementById('btn-volver-informe').className = 'px-4 py-2 rounded-xl font-semibold transition-all bg-slate-100 text-slate-600 hover:bg-slate-200';
        document.getElementById('card-paciente').className = 'p-4 rounded-2xl bg-gradient-to-r from-teal-50 to-cyan-50';
        document.getElementById('label-paciente').className = 'text-xs font-semibold uppercase tracking-wider text-teal-600';
        document.getElementById('valor-paciente').className = 'text-lg font-bold text-slate-800';
        document.getElementById('card-guardia-info').className = 'p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-orange-50';
        document.getElementById('label-guardia-info').className = 'text-xs font-semibold uppercase tracking-wider text-amber-600';
        document.getElementById('valor-guardia-info').className = 'text-lg font-bold text-slate-800';
        document.getElementById('card-enfermero').className = 'p-4 rounded-2xl bg-slate-50';
        document.getElementById('label-enfermero').className = 'text-xs font-semibold uppercase tracking-wider text-slate-500';
        document.getElementById('valor-enfermero').className = 'font-bold text-slate-800';
        document.getElementById('card-auxiliar').className = 'p-4 rounded-2xl bg-slate-50';
        document.getElementById('label-auxiliar').className = 'text-xs font-semibold uppercase tracking-wider text-slate-500';
        document.getElementById('valor-auxiliar').className = 'font-bold text-slate-800';
        document.getElementById('label-progreso-informe').className = 'font-semibold text-slate-600';
        document.getElementById('valor-progreso-informe').className = 'text-2xl font-black text-teal-600';
        document.getElementById('barra-progreso-informe-bg').className = 'h-4 rounded-full overflow-hidden bg-slate-100';
        document.getElementById('barra-progreso-informe').className = 'h-full rounded-full transition-all duration-500 bg-gradient-to-r from-amber-400 to-orange-500';
        document.getElementById('card-resumen-medicacion').className = 'rounded-2xl p-4 mb-3 border bg-white shadow-lg border-slate-100';
        document.getElementById('icono-med-informe').className = 'w-5 h-5 text-rose-500';
        document.getElementById('titulo-med-informe').className = 'font-bold text-slate-800';
        document.getElementById('card-resumen-tareas').className = 'rounded-2xl p-4 mb-3 border bg-white shadow-lg border-slate-100';
        document.getElementById('icono-tar-informe').className = 'w-5 h-5 text-sky-500';
        document.getElementById('titulo-tar-informe').className = 'font-bold text-slate-800';
        document.getElementById('card-resumen-rotaciones').className = 'rounded-2xl p-4 mb-3 border bg-white shadow-lg border-slate-100';
        document.getElementById('icono-rot-informe').className = 'w-5 h-5 text-violet-500';
        document.getElementById('titulo-rot-informe').className = 'font-bold text-slate-800';
        document.getElementById('card-resumen-sv').className = 'rounded-2xl p-4 mb-3 border bg-white shadow-lg border-slate-100';
        document.getElementById('icono-sv-informe').className = 'w-5 h-5 text-red-500';
        document.getElementById('titulo-sv-informe').className = 'font-bold text-slate-800';
        document.getElementById('card-observaciones').className = 'rounded-2xl p-4 mb-4 border bg-white shadow-lg border-slate-100';
        document.getElementById('titulo-obs').className = 'font-bold text-slate-800 mb-2';
        document.getElementById('input-observaciones').className = 'w-full p-3 rounded-xl border-2 outline-none min-h-24 border-slate-200 focus:border-teal-400';
        document.getElementById('btn-enviar-informe').className = 'w-full py-4 rounded-2xl text-lg font-bold tracking-wide transition-all duration-300 flex items-center justify-center gap-3 text-white bg-gradient-to-r from-amber-400 to-orange-500 shadow-lg';
      }
    }

    function renderizarInforme() {
      const esNocturna = guardiaActual === 'nocturna';
      const meds = getMedicacionGuardia();
      const tars = getTareasGuardia();

      // Fecha
      const now = new Date();
      document.getElementById('fecha-informe').textContent = now.toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      // Info
      document.getElementById('valor-guardia-info').textContent = guardiaActual === 'diurna' ? 'Diurna (08:00 - 20:00)' : 'Nocturna (20:00 - 08:00)';
      document.getElementById('valor-enfermero').textContent = enfermero;
      document.getElementById('valor-auxiliar').textContent = auxiliar;

      // Progreso
      const totalMed = meds.length;
      const totalTar = tars.length;
      const completadasMed = Object.keys(medicacionCompletada).filter(k => meds.some(m => m.id == k)).length;
      const completadasTar = Object.keys(tareasCompletadas).filter(k => tars.some(t => t.id == k)).length;
      const total = totalMed + totalTar;
      const completadas = completadasMed + completadasTar;
      const progreso = total > 0 ? Math.round((completadas / total) * 100) : 0;

      document.getElementById('valor-progreso-informe').textContent = progreso + '%';
      document.getElementById('barra-progreso-informe').style.width = progreso + '%';

      // Medicaci√≥n
      document.getElementById('lista-med-informe').innerHTML = meds.map(med => {
        const completado = medicacionCompletada[med.id];
        return `
          <div class="p-3 rounded-xl ${completado ? (esNocturna ? 'bg-emerald-500/20' : 'bg-emerald-50') : (esNocturna ? 'bg-red-500/20' : 'bg-red-50')}">
            <div class="flex justify-between items-center">
              <span class="font-bold ${esNocturna ? 'text-white' : 'text-slate-800'}">${med.hora}</span>
              <span class="text-sm font-semibold ${completado ? 'text-emerald-500' : 'text-red-500'}">
                ${completado ? `‚úì ${completado}` : '‚úó No administrado'}
              </span>
            </div>
            <div class="text-sm ${esNocturna ? 'text-slate-300' : 'text-slate-600'}">
              ${med.medicamentos.map(m => m.nombre).join(', ')}
            </div>
          </div>
        `;
      }).join('');

      // Tareas
      document.getElementById('lista-tar-informe').innerHTML = tars.map(t => {
        const completado = tareasCompletadas[t.id];
        return `
          <div class="p-2 rounded-xl ${completado ? (esNocturna ? 'bg-emerald-500/20' : 'bg-emerald-50') : (esNocturna ? 'bg-red-500/20' : 'bg-red-50')}">
            <p class="font-medium text-sm ${esNocturna ? 'text-white' : 'text-slate-800'}">${t.nombre}</p>
            <p class="text-xs ${completado ? 'text-emerald-500' : 'text-red-500'}">
              ${completado ? `‚úì ${completado}` : 'No realizado'}
            </p>
          </div>
        `;
      }).join('');

      // Rotaciones
      document.getElementById('titulo-rot-informe').textContent = `Rotaciones Realizadas: ${rotacionesRealizadas.length}`;
      document.getElementById('lista-rot-informe').innerHTML = rotacionesRealizadas.length > 0
        ? rotacionesRealizadas.map(r => `
            <div class="flex items-center justify-between p-2 rounded-xl ${esNocturna ? 'bg-white/5' : 'bg-slate-50'}">
              <span class="font-medium ${esNocturna ? 'text-white' : 'text-slate-800'}">${r.posicion}</span>
              <span class="${esNocturna ? 'text-slate-400' : 'text-slate-500'}">${r.hora}</span>
            </div>
          `).join('')
        : `<p class="${esNocturna ? 'text-slate-400' : 'text-slate-500'}">No se registraron rotaciones</p>`;

      // Signos Vitales
      const sv = {
        pa: document.getElementById('sv-pa').value,
        fc: document.getElementById('sv-fc').value,
        temp: document.getElementById('sv-temp').value,
        spo2: document.getElementById('sv-spo2').value,
        fr: document.getElementById('sv-fr').value,
        gluc: document.getElementById('sv-gluc').value
      };

      document.getElementById('lista-sv-informe').innerHTML = [
        { label: 'PA', value: sv.pa },
        { label: 'FC', value: sv.fc },
        { label: 'T¬∞', value: sv.temp },
        { label: 'SpO2', value: sv.spo2 },
        { label: 'FR', value: sv.fr },
        { label: 'Gluc ü©∏', value: sv.gluc }
      ].map(s => `
        <div class="p-2 rounded-xl text-center ${esNocturna ? 'bg-white/5' : 'bg-slate-50'}">
          <p class="text-xs font-semibold ${esNocturna ? 'text-slate-400' : 'text-slate-500'}">${s.label}</p>
          <p class="font-bold ${esNocturna ? 'text-white' : 'text-slate-800'}">${s.value || '-'}</p>
        </div>
      `).join('');
    }
    // ==================== FUNCIONES DE REPORTES CON SINCRONIZACI√ìN ====================

    async function guardarReporte(informe) {
      // Agregar ID √∫nico y fecha
      informe.id = Date.now();
      informe.fechaEnvio = new Date().toISOString();

      // 1. Guardar en localStorage como respaldo
      let reportesLocal = [];
      try {
        const guardados = localStorage.getItem('recaldeHealthReportes');
        if (guardados) {
          reportesLocal = JSON.parse(guardados);
        }
      } catch (e) {
        reportesLocal = [];
      }
      reportesLocal.unshift(informe);
      if (reportesLocal.length > 100) {
        reportesLocal = reportesLocal.slice(0, 100);
      }
      localStorage.setItem('recaldeHealthReportes', JSON.stringify(reportesLocal));

      // 2. Guardar en Supabase si est√° disponible
      if (supabaseClient) {
        try {
          const { data, error } = await supabaseClient
            .from('reportes_guardia')
            .insert([{
              reporte_id: informe.id,
              fecha: informe.fecha,
              guardia: informe.guardia,
              guardia_texto: informe.guardiaTexto,
              enfermero: informe.enfermero,
              auxiliar: informe.auxiliar,
              paciente: informe.paciente,
              signos_vitales: informe.signosVitales,
              mensaje_importante: informe.mensajeImportante,
              observaciones: informe.observaciones,
              progreso: informe.progreso,
              medicacion_detalle: informe.medicacionDetalle,
              tareas_detalle: informe.tareasDetalle,
              rotaciones_realizadas: informe.rotacionesRealizadas,
              leido: false,
              fecha_envio: informe.fechaEnvio,
              datos_completos: informe // Guardar el objeto completo tambi√©n
            }]);

          if (error) {
            console.error('[Supabase] Error al guardar reporte:', error);
          } else {
            console.log('[Supabase] Reporte guardado en la nube');
          }
        } catch (e) {
          console.error('[Supabase] Error:', e);
        }
      }

      return true;
    }

    async function obtenerReportes() {
      let reportes = [];

      // 1. Intentar obtener de Supabase primero
      if (supabaseClient) {
        try {
          const { data, error } = await supabaseClient
            .from('reportes_guardia')
            .select('*')
            .order('fecha_envio', { ascending: false })
            .limit(100);

          if (!error && data && data.length > 0) {
            console.log('[Supabase] Reportes obtenidos de la nube:', data.length);
            // Convertir del formato de Supabase al formato de la app
            reportes = data.map(r => ({
              id: r.reporte_id,
              fecha: r.fecha,
              guardia: r.guardia,
              guardiaTexto: r.guardia_texto,
              enfermero: r.enfermero,
              auxiliar: r.auxiliar,
              paciente: r.paciente,
              signosVitales: r.signos_vitales,
              mensajeImportante: r.mensaje_importante,
              observaciones: r.observaciones,
              progreso: r.progreso,
              medicacionDetalle: r.medicacion_detalle,
              tareasDetalle: r.tareas_detalle,
              rotacionesRealizadas: r.rotaciones_realizadas,
              leido: r.leido,
              fechaEnvio: r.fecha_envio,
              supabaseId: r.id // Guardar el ID de Supabase para updates
            }));

            // Actualizar localStorage con los datos de la nube
            localStorage.setItem('recaldeHealthReportes', JSON.stringify(reportes));
            return reportes;
          }
        } catch (e) {
          console.log('[Supabase] Error al obtener reportes, usando localStorage:', e);
        }
      }

      // 2. Fallback a localStorage
      try {
        const guardados = localStorage.getItem('recaldeHealthReportes');
        if (guardados) {
          return JSON.parse(guardados);
        }
      } catch (e) { }
      return [];
    }

    async function eliminarReporte(id) {
      // 1. Eliminar de Supabase
      if (supabaseClient) {
        try {
          await supabaseClient
            .from('reportes_guardia')
            .delete()
            .eq('reporte_id', id);
          console.log('[Supabase] Reporte eliminado de la nube');
        } catch (e) {
          console.error('[Supabase] Error al eliminar:', e);
        }
      }

      // 2. Eliminar de localStorage
      let reportes = [];
      try {
        const guardados = localStorage.getItem('recaldeHealthReportes');
        if (guardados) {
          reportes = JSON.parse(guardados);
        }
      } catch (e) { }
      reportes = reportes.filter(r => r.id !== id);
      localStorage.setItem('recaldeHealthReportes', JSON.stringify(reportes));

      renderizarReportesAdmin();
      actualizarBadgeReportes();
    }

    async function marcarComoLeido(id) {
      // 1. Actualizar en Supabase
      if (supabaseClient) {
        try {
          await supabaseClient
            .from('reportes_guardia')
            .update({ leido: true })
            .eq('reporte_id', id);
          console.log('[Supabase] Reporte marcado como le√≠do en la nube');
        } catch (e) {
          console.error('[Supabase] Error al marcar como le√≠do:', e);
        }
      }

      // 2. Actualizar en localStorage
      let reportes = [];
      try {
        const guardados = localStorage.getItem('recaldeHealthReportes');
        if (guardados) {
          reportes = JSON.parse(guardados);
        }
      } catch (e) { }
      reportes = reportes.map(r => {
        if (r.id === id) {
          r.leido = true;
        }
        return r;
      });
      localStorage.setItem('recaldeHealthReportes', JSON.stringify(reportes));

      renderizarReportesAdmin();
      actualizarBadgeReportes();
    }

    async function contarReportesNoLeidos() {
      const reportes = await obtenerReportes();
      return reportes.filter(r => r.leido === false).length;
    }

    async function actualizarBadgeReportes() {
      const badge = document.getElementById('badge-reportes-nuevos');
      if (!badge) return;

      const noLeidos = await contarReportesNoLeidos();
      if (noLeidos > 0) {
        badge.textContent = noLeidos;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }


    function enviarInforme() {
      const btn = document.getElementById('btn-enviar-informe');
      const textoBtn = document.getElementById('texto-btn-enviar');

      // Crear objeto de informe
      const informe = {
        fecha: new Date().toLocaleString('es-AR'),
        guardia: guardiaActual,
        guardiaTexto: guardiaActual === 'diurna' ? 'Diurna (08:00 - 20:00)' : 'Nocturna (20:00 - 08:00)',
        enfermero,
        auxiliar,
        paciente: 'Patricio Recalde',
        medicacionCompletada: { ...medicacionCompletada },
        tareasCompletadas: { ...tareasCompletadas },
        rotacionesRealizadas: [...rotacionesRealizadas],
        totalMedicacion: getMedicacionGuardia().length,
        totalTareas: getTareasGuardia().length,
        medicacionDetalle: getMedicacionGuardia().map(m => ({
          hora: m.hora,
          medicamentos: m.medicamentos.map(med => med.nombre).join(', '),
          completado: !!medicacionCompletada[m.id],
          horaCompletado: medicacionCompletada[m.id] || null
        })),
        tareasDetalle: getTareasGuardia().map(t => ({
          nombre: t.nombre,
          horario: t.horario,
          completado: !!tareasCompletadas[t.id],
          horaCompletado: tareasCompletadas[t.id] || null
        })),
        signosVitales: {
          pa: document.getElementById('sv-pa').value,
          fc: document.getElementById('sv-fc').value,
          temp: document.getElementById('sv-temp').value,
          spo2: document.getElementById('sv-spo2').value,
          fr: document.getElementById('sv-fr').value,
          gluc: document.getElementById('sv-gluc').value
        },
        mensajeImportante: document.getElementById('input-mensaje-importante').value.trim(),
        observaciones: document.getElementById('input-observaciones').value,
        progreso: calcularProgresoDetallado(),
        leido: false // Marcar como no le√≠do
      };

      // Guardar reporte localmente
      const guardado = guardarReporte(informe);

      if (guardado) {
        // Enviar por email usando Web3Forms
        enviarReportePorEmail(informe);

        // Mostrar √©xito
        btn.classList.remove('bg-gradient-to-r', 'from-amber-400', 'to-orange-500', 'from-emerald-400', 'to-teal-400');
        btn.classList.add('bg-emerald-500');
        textoBtn.textContent = '‚úì ¬°Informe Guardado y Enviado por Email!';

        console.log('Informe guardado:', informe);

        // Limpiar guardia despu√©s de enviar
        limpiarGuardia();

        setTimeout(() => {
          const esNocturna = guardiaActual === 'nocturna';
          btn.classList.remove('bg-emerald-500');
          btn.classList.add('bg-gradient-to-r');
          if (esNocturna) {
            btn.classList.add('from-emerald-400', 'to-teal-400');
          } else {
            btn.classList.add('from-amber-400', 'to-orange-500');
          }
          textoBtn.textContent = 'Enviar Informe al Administrador';

          // Preguntar si quiere volver al inicio
          if (confirm('¬°Informe enviado por email!\\n\\nEl reporte se envi√≥ a pmrecalde91@gmail.com y tambi√©n est√° guardado localmente.\\n\\n¬øQuer√©s volver a la pantalla de inicio?')) {
            if (checkAlarmsInterval) clearInterval(checkAlarmsInterval);
            volverInicio();
          }
        }, 2000);
      } else {
        alert('Error al guardar el informe. Intent√° de nuevo.');
      }
    }

    // Funci√≥n para enviar reporte por email usando Web3Forms
    async function enviarReportePorEmail(informe) {
      try {
        // Formatear el contenido del email
        const sv = informe.signosVitales || {};
        const progreso = informe.progreso || {};

        let mensajeEmail = `
üìã REPORTE DE GUARDIA - RECALDE HEALTH SYSTEM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìÖ Fecha: ${informe.fecha}
üè• Guardia: ${informe.guardiaTexto || informe.guardia}
üë®‚Äç‚öïÔ∏è Enfermero/a: ${informe.enfermero}
üë§ Auxiliar: ${informe.auxiliar}
üè† Paciente: ${informe.paciente}

üìä PROGRESO: ${progreso.porcentaje || 0}%
   ‚Ä¢ Medicaci√≥n: ${progreso.medicacion?.completadas || 0}/${progreso.medicacion?.total || 0}
   ‚Ä¢ Tareas: ${progreso.tareas?.completadas || 0}/${progreso.tareas?.total || 0}
   ‚Ä¢ Rotaciones: ${progreso.rotaciones || 0}

üíì SIGNOS VITALES:
   ‚Ä¢ PA: ${sv.pa || 'N/R'}
   ‚Ä¢ FC: ${sv.fc || 'N/R'}
   ‚Ä¢ T¬∞: ${sv.temp || 'N/R'}
   ‚Ä¢ SpO2: ${sv.spo2 || 'N/R'}
   ‚Ä¢ FR: ${sv.fr || 'N/R'}
   ‚Ä¢ Glucemia: ${sv.gluc || 'N/R'}
`;

        if (informe.mensajeImportante) {
          mensajeEmail += `
‚ö†Ô∏è MENSAJE IMPORTANTE:
${informe.mensajeImportante}
`;
        }

        if (informe.observaciones) {
          mensajeEmail += `
üìù OBSERVACIONES:
${informe.observaciones}
`;
        }

        // Detalle de medicaci√≥n
        if (informe.medicacionDetalle && informe.medicacionDetalle.length > 0) {
          mensajeEmail += `
üíä DETALLE MEDICACI√ìN:
`;
          informe.medicacionDetalle.forEach(m => {
            const estado = m.completado ? '‚úÖ' : '‚ùå';
            mensajeEmail += `   ${estado} ${m.hora} - ${m.medicamentos}${m.horaCompletado ? ' (a las ' + m.horaCompletado + ')' : ''}
`;
          });
        }

        // Detalle de tareas
        if (informe.tareasDetalle && informe.tareasDetalle.length > 0) {
          mensajeEmail += `
üìã DETALLE TAREAS:
`;
          informe.tareasDetalle.forEach(t => {
            const estado = t.completado ? '‚úÖ' : '‚ùå';
            mensajeEmail += `   ${estado} ${t.nombre} - ${t.horario}${t.horaCompletado ? ' (a las ' + t.horaCompletado + ')' : ''}
`;
          });
        }

        mensajeEmail += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Enviado desde Recalde Health System
`;

        // Enviar usando Web3Forms
        const formData = new FormData();
        formData.append('access_key', 'e0d802b6-7d30-423c-83db-f43045c7d98d'); // Access key para pmrecalde91@gmail.com
        formData.append('subject', `üè• Reporte de Guardia ${informe.guardiaTexto || informe.guardia} - ${informe.enfermero}`);
        formData.append('from_name', 'Recalde Health System');
        formData.append('email', 'noreply@recaldehealth.com');
        formData.append('message', mensajeEmail);

        const response = await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          console.log('Email enviado correctamente');
        } else {
          console.error('Error al enviar email:', result);
        }
      } catch (error) {
        console.error('Error al enviar email:', error);
        // No mostramos alerta para no interrumpir, el reporte ya se guard√≥ localmente
      }
    }

    function calcularProgresoDetallado() {
      const meds = getMedicacionGuardia();
      const tars = getTareasGuardia();
      const completadasMed = Object.keys(medicacionCompletada).filter(k => meds.some(m => m.id == k)).length;
      const completadasTar = Object.keys(tareasCompletadas).filter(k => tars.some(t => t.id == k)).length;

      return {
        medicacion: { completadas: completadasMed, total: meds.length },
        tareas: { completadas: completadasTar, total: tars.length },
        rotaciones: rotacionesRealizadas.length,
        porcentaje: Math.round(((completadasMed + completadasTar) / (meds.length + tars.length)) * 100) || 0
      };
    }

    // ==================== INICIALIZACI√ìN ====================
    document.getElementById('input-enfermero').addEventListener('input', validarFormulario);
    document.getElementById('input-auxiliar').addEventListener('input', validarFormulario);

    actualizarHora();
    setInterval(actualizarHora, 1000);

    // Verificar si hay una sesi√≥n guardada
    window.addEventListener('load', function () {
      // Inicializar Supabase para sincronizaci√≥n de reportes
      initSupabase();

      // Actualizar badge de reportes no le√≠dos
      actualizarBadgeReportes();
      const estadoGuardado = cargarEstado();
      if (estadoGuardado) {
        const tiempoTranscurrido = Math.round((Date.now() - estadoGuardado.timestamp) / 60000);
        const mensaje = `Se encontr√≥ una guardia ${estadoGuardado.guardiaActual} en progreso.\n\n` +
          `Enfermero/a: ${estadoGuardado.enfermero}\n` +
          `Auxiliar: ${estadoGuardado.auxiliar}\n` +
          `√öltima actividad: hace ${tiempoTranscurrido} minutos\n\n` +
          `¬øQuer√©s continuar con esa guardia?`;

        if (confirm(mensaje)) {
          const signosVitales = restaurarEstado(estadoGuardado);
          validarFormulario();
          iniciarGuardia(estadoGuardado.guardiaActual, signosVitales);
        } else {
          limpiarGuardia();
        }
      }
    });

    // ==================== PWA INSTALLATION ====================
    let deferredPrompt;
    const installBanner = document.getElementById('install-banner');

    // Detectar si ya est√° instalada como PWA
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
      window.navigator.standalone === true;

    if (isStandalone) {
      console.log('[PWA] App ejecut√°ndose en modo standalone');
      installBanner.style.display = 'none';
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA] beforeinstallprompt disparado');
      e.preventDefault();
      deferredPrompt = e;

      // Mostrar banner si no est√° instalada y no se cerr√≥ antes
      if (!sessionStorage.getItem('installBannerClosed') && !isStandalone) {
        setTimeout(() => {
          installBanner.classList.add('show');
        }, 2000);
      }
    });

    window.addEventListener('appinstalled', (e) => {
      console.log('[PWA] App instalada exitosamente');
      installBanner.classList.remove('show');
      deferredPrompt = null;
    });

    function installPWA() {
      if (!deferredPrompt) {
        // Si no hay prompt, mostrar instrucciones
        alert('Para instalar la app:\n\n' +
          'üì± Android (Chrome):\n' +
          'Men√∫ ‚ãÆ ‚Üí "Instalar aplicaci√≥n"\n\n' +
          'üì± iPhone (Safari):\n' +
          'Compartir ‚Üí "Agregar a inicio"');
        return;
      }

      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        console.log('[PWA] Usuario eligi√≥:', choiceResult.outcome);
        deferredPrompt = null;
        installBanner.classList.remove('show');
      });
    }

    function closeInstallBanner() {
      installBanner.classList.remove('show');
      sessionStorage.setItem('installBannerClosed', 'true');
    }

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('[SW] Registrado con scope:', registration.scope);

            // Verificar actualizaciones
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('[SW] Nueva versi√≥n disponible');
                }
              });
            });
          })
          .catch((error) => {
            console.log('[SW] Error en registro:', error);
          });
      });
    }
  </script>
</body>

</html>